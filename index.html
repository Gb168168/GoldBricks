<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âì°Â∑•ÂÅáÁÆ°ÁêÜÁ≥ªÁµ±</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide Icons ÁµÑ‰ª∂
        const Users = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const Calendar = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const FileText = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
        );

        const Clock = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        );

        const Clipboard = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
            </svg>
        );

        const LogOut = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
        );

        const Download = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const Trash2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        );

        const Edit2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
            </svg>
        );

        const Bell = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
        );

        const regionOptions = ['Êñ∞Á´πÂçÄ', 'Âè∞‰∏≠ÂçÄ', 'ÂòâÁæ©ÂçÄ'];
        const departmentOptions = ['ÁÆ°ÁêÜÈÉ®', 'TSE', 'FAE', 'Êñ∞Â†¥', 'ÂÄâÁÆ°', 'RD', 'Á∑ö‰∏äÂÆ¢Êúç'];

        // ÂàùÂßãÂåñË≥áÊñô
        const initialData = {
            users: [
                {
                    id: 'E001',
                    username: 'admin',
                    password: 'admin123',
                    name: 'ÁÆ°ÁêÜÂì°',
                    region: 'Êñ∞Á´πÂçÄ',
                    department: 'ÁÆ°ÁêÜÈÉ®',
                    position: 'Á∂ìÁêÜ',
                    email: 'admin@company.com',
                    phone: '0912-345-678',
                    birthday: '1980-01-01',
                    shift: ['Êó©'],
                    isAdmin: true,
                    permissionRegions: [...regionOptions],
                    permissionDepartments: [...departmentOptions],
                    annualLeave: 14,
                    usedAnnualLeave: 0
                },
                {
                    id: 'E002',
                    username: 'user001',
                    password: 'pass123',
                    name: 'ÁéãÂ∞èÊòé',
                    region: 'Âè∞‰∏≠ÂçÄ',
                    department: 'TSE',
                    position: 'Â∞àÂì°',
                    email: 'wang@company.com',
                    phone: '0923-456-789',
                    birthday: '1990-05-15',
                    shift: ['Êó©', 'Êôö'],
                    isAdmin: false,
                    permissionRegions: [],
                    permissionDepartments: [],
                    annualLeave: 10,
                    usedAnnualLeave: 2
                }
            ],
            leaves: [],
            auditLogs: [],
            vacationSettings: {
                openStart: '',
                openEnd: '',
                monthlyVacationDays: ''
            },
            vacationSchedule: {},
            vacationNotes: {}
        };

        // ÂúãÂÆöÂÅáÊó•Ë≥áÊñô
        const holidays2026 = [
            { date: '2026-01-01', name: 'ÂÖÉÊó¶' },
            { date: '2026-02-15', name: 'Â∞èÂπ¥Â§ú' },
            { date: '2026-02-16', name: 'Èô§Â§ï' },
            { date: '2026-02-17', name: 'Âàù‰∏Ä' },
            { date: '2026-02-18', name: 'Âàù‰∫å' },
            { date: '2026-02-19', name: 'Âàù‰∏â' },
            { date: '2026-02-27', name: '228ÈÄ£ÂÅá' },
            { date: '2026-02-28', name: '228Á¥ÄÂøµÊó•' },
            { date: '2026-04-03', name: 'ÂÖíÁ´•ÁØÄ' },
            { date: '2026-04-04', name: 'Ê∏ÖÊòéÁØÄ' },
            { date: '2026-06-25', name: 'Á´ØÂçàÁØÄ' },
            { date: '2026-10-01', name: '‰∏≠ÁßãÁØÄ' },
            { date: '2026-10-10', name: 'ÂúãÊÖ∂Êó•' }
        ];

        const CURRENT_USER_STORAGE_KEY = 'leaveSystemCurrentUserId';

        const EmployeeLeaveSystem = () => {
             const [currentUser, setCurrentUser] = useState(() => {
                const savedData = localStorage.getItem('leaveSystemData');
                const savedUserId = localStorage.getItem(CURRENT_USER_STORAGE_KEY);

                if (!savedData || !savedUserId) return null;

                try {
                    const parsed = JSON.parse(savedData);
                    return (parsed.users || []).find(user => user.id === savedUserId) || null;
                } catch (error) {
                    return null;
                }
            });
            const [activeTab, setActiveTab] = useState('vacation');
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem('leaveSystemData');
                     if (!saved) return initialData;
                const parsed = JSON.parse(saved);
                return {
                    ...initialData,
                    ...parsed,
                    vacationSettings: {
                        ...initialData.vacationSettings,
                        ...parsed.vacationSettings
                    },
                    vacationSchedule: parsed.vacationSchedule || {},
                    vacationNotes: parsed.vacationNotes || {}
                };
            });

            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [selectedMonth, setSelectedMonth] = useState(new Date(2026, 1)); // 2Êúà
            const [filterRegion, setFilterRegion] = useState('ÂÖ®ÈÉ®');
            const [filterDepartment, setFilterDepartment] = useState('ÂÖ®ÈÉ®');
            const [filterShift, setFilterShift] = useState('ÂÖ®ÈÉ®');
            const [selectedVacationMarker, setSelectedVacationMarker] = useState('‚ñ≤-black');
            const [showVacationSettings, setShowVacationSettings] = useState(false);
            const [newLeaveForm, setNewLeaveForm] = useState({
                type: 'Áâπ‰ºë',
                startDate: '',
                endDate: '',
                reason: '',
                hours: 8
            });

            const [showAddUser, setShowAddUser] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [newUserForm, setNewUserForm] = useState({
                id: '',
                username: '',
                password: '',
                name: '',
                region: regionOptions[0],
                department: departmentOptions[0],
                position: 'Â∞àÂì°',
                email: '',
                phone: '',
                birthday: '',
                shift: [],
                annualLeave: 10,
                isAdmin: false,
                permissionRegions: [...regionOptions],
                permissionDepartments: [...departmentOptions]
            });

            useEffect(() => {
                localStorage.setItem('leaveSystemData', JSON.stringify(data));
            }, [data]);

            useEffect(() => {
                if (currentUser?.id) {
                    localStorage.setItem(CURRENT_USER_STORAGE_KEY, currentUser.id);
                } else {
                    localStorage.removeItem(CURRENT_USER_STORAGE_KEY);
                }
            }, [currentUser]);

            useEffect(() => {
                if (!currentUser?.id) return;

                const latestUser = data.users.find(user => user.id === currentUser.id);
                if (!latestUser) {
                    setCurrentUser(null);
                    setActiveTab('vacation');
                    return;
                }

                if (JSON.stringify(latestUser) !== JSON.stringify(currentUser)) {
                    setCurrentUser(latestUser);
                }
            }, [data.users, currentUser]);

            const handleLogin = (e) => {
                e.preventDefault();
                const user = data.users.find(
                    u => u.username === loginForm.username && u.password === loginForm.password
                );
                if (user) {
                    setCurrentUser(user);
                } else {
                    alert('Â∏≥ËôüÊàñÂØÜÁ¢ºÈåØË™§');
                }
            };

            const handleLogout = () => {
                setCurrentUser(null);
            };

            const handleDeleteUser = (userId) => {
                const user = data.users.find(u => u.id === userId);
                if (!user || !canManageUser(user)) {
                    alert('ÁÑ°Ê¨äÈôêÂà™Èô§Ê≠§Âì°Â∑•');
                    return;
                }
                if (window.confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Âì°Â∑•Âóé?')) {
                    setData(prev => ({
                        ...prev,
                        users: prev.users.filter(u => u.id !== userId),
                        auditLogs: [...prev.auditLogs, {
                            timestamp: new Date().toISOString(),
                            user: currentUser.name,
                            action: 'Âà™Èô§Âì°Â∑•',
                            details: user.name
                        }]
                    }));
                }
            };

            const handleEditUser = (user) => {
                if (!canManageUser(user)) {
                    alert('ÁÑ°Ê¨äÈôêÁ∑®ËºØÊ≠§Âì°Â∑•Ë≥áÊñô');
                    return;
                }
                setEditingUser(user);
                setNewUserForm({
                    id: user.id,
                    username: user.username,
                    password: user.password,
                    name: user.name,
                    region: user.region,
                    department: user.department,
                    position: user.position,
                    email: user.email,
                    phone: user.phone,
                    birthday: user.birthday,
                    shift: user.shift,
                    annualLeave: user.annualLeave,
                    isAdmin: user.isAdmin || false,
                    permissionRegions: Array.isArray(user.permissionRegions) ? user.permissionRegions : [...regionOptions],
                    permissionDepartments: Array.isArray(user.permissionDepartments) ? user.permissionDepartments : [...departmentOptions]
                });
                setShowAddUser(true);
            };

            const handleAddUser = (e) => {
                e.preventDefault();
                
                if (editingUser) {
                    // Á∑®ËºØÊ®°Âºè
                    setData(prev => ({
                        ...prev,
                        users: prev.users.map(u => 
                            u.id === editingUser.id 
                                ? { ...newUserForm, usedAnnualLeave: u.usedAnnualLeave }
                                : u
                        ),
                        auditLogs: [...prev.auditLogs, {
                            timestamp: new Date().toISOString(),
                            user: currentUser.name,
                            action: 'Á∑®ËºØÂì°Â∑•',
                            details: `${newUserForm.id} - ${newUserForm.name}`
                        }]
                    }));
                    alert('Âì°Â∑•Ë≥áÊñôÊõ¥Êñ∞ÊàêÂäü!');
                } else {
                    // Êñ∞Â¢ûÊ®°Âºè
                    // Ê™¢Êü•Âì°Â∑•‰ª£ËôüÊòØÂê¶Â∑≤Â≠òÂú®
                    if (data.users.find(u => u.id === newUserForm.id)) {
                        alert('Âì°Â∑•‰ª£ËôüÂ∑≤Â≠òÂú®,Ë´ã‰ΩøÁî®ÂÖ∂‰ªñ‰ª£Ëôü!');
                        return;
                    }
                    
                    // Ê™¢Êü•Â∏≥ËôüÊòØÂê¶Â∑≤Â≠òÂú®
                    if (data.users.find(u => u.username === newUserForm.username)) {
                        alert('Â∏≥ËôüÂ∑≤Â≠òÂú®,Ë´ã‰ΩøÁî®ÂÖ∂‰ªñÂ∏≥Ëôü!');
                        return;
                    }
                    
                    const newUser = {
                        ...newUserForm,
                        usedAnnualLeave: 0
                    };
                    
                    setData(prev => ({
                        ...prev,
                        users: [...prev.users, newUser],
                        auditLogs: [...prev.auditLogs, {
                            timestamp: new Date().toISOString(),
                            user: currentUser.name,
                            action: 'Êñ∞Â¢ûÂì°Â∑•',
                            details: `${newUser.id} - ${newUser.name}`
                        }]
                    }));
                    alert('Âì°Â∑•Êñ∞Â¢ûÊàêÂäü!');
                }
                
                setNewUserForm({
                    id: '',
                    username: '',
                    password: '',
                    name: '',
                    region: regionOptions[0],
                    department: departmentOptions[0],
                    position: 'Â∞àÂì°',
                    email: '',
                    phone: '',
                    birthday: '',
                    shift: [],
                    annualLeave: 10,
                    isAdmin: false,
                    permissionRegions: [...regionOptions],
                    permissionDepartments: [...departmentOptions]
                });
                
                setShowAddUser(false);
                setEditingUser(null);
            };

            const toggleShift = (shiftType) => {
                setNewUserForm(prev => ({
                    ...prev,
                    shift: prev.shift.includes(shiftType)
                        ? prev.shift.filter(s => s !== shiftType)
                        : [...prev.shift, shiftType]
                }));
            };

            const togglePermission = (type, value) => {
                setNewUserForm(prev => {
                    const key = type === 'region' ? 'permissionRegions' : 'permissionDepartments';
                    const current = prev[key] || [];
                    const next = current.includes(value)
                        ? current.filter(item => item !== value)
                        : [...current, value];
                    return { ...prev, [key]: next };
                });
            };

            const getEffectivePermissions = (permissions, allOptions) =>
                Array.isArray(permissions) ? permissions : allOptions;

            const canManageUser = (targetUser) => {
                if (!currentUser?.isAdmin) return false;
                const regionPermissions = getEffectivePermissions(currentUser.permissionRegions, regionOptions);
                const departmentPermissions = getEffectivePermissions(currentUser.permissionDepartments, departmentOptions);
                return regionPermissions.includes(targetUser.region) || departmentPermissions.includes(targetUser.department);
            };

            const canApproveLeave = (leave) => {
                if (!currentUser?.isAdmin) return false;
                const regionPermissions = getEffectivePermissions(currentUser.permissionRegions, regionOptions);
                const departmentPermissions = getEffectivePermissions(currentUser.permissionDepartments, departmentOptions);
                return regionPermissions.includes(leave.region) || departmentPermissions.includes(leave.department);
            };

            const pendingLeaves = data.leaves.filter(l => l.status === 'ÂæÖÂØ©Ê†∏');
            
            const handleSubmitLeave = (e) => {
                e.preventDefault();
                const newLeave = {
                    id: Date.now().toString(),
                    userId: currentUser.id,
                    userName: currentUser.name,
                    department: currentUser.department,
                    region: currentUser.region,
                    ...newLeaveForm,
                    status: 'ÂæÖÂØ©Ê†∏',
                    submittedAt: new Date().toISOString()
                };
                
                setData(prev => ({
                    ...prev,
                    leaves: [...prev.leaves, newLeave]
                }));
                
                setNewLeaveForm({
                    type: 'Áâπ‰ºë',
                    startDate: '',
                    endDate: '',
                    reason: '',
                    hours: 8
                });
                
                alert('Ë´ãÂÅáÁî≥Ë´ãÂ∑≤ÈÄÅÂá∫');
            };

            const handleApproveLeave = (leaveId, status) => {
                const targetLeave = data.leaves.find(l => l.id === leaveId);
                if (!targetLeave || !canApproveLeave(targetLeave)) {
                    alert('ÁÑ°Ê¨äÈôêÂØ©Ê†∏Ê≠§Ë´ãÂÅáÁî≥Ë´ã');
                    return;
                }
                setData(prev => ({
                    ...prev,
                    leaves: prev.leaves.map(l => 
                        l.id === leaveId ? { ...l, status } : l
                    )
                }));
            };

            const exportToCSV = (type) => {
                let csv = '';
                let filename = '';
                
                if (type === 'users') {
                    csv = 'Âì°Â∑•‰ª£Ëôü,ÂßìÂêç,Âú∞ÂçÄ,ÈÉ®ÈñÄ,ËÅ∑Á®±,Email,ÈõªË©±,ÁîüÊó•,Áè≠Âà•,Á∏ΩÁâπ‰ºë,Â∑≤‰ΩøÁî®Áâπ‰ºë,Ââ©È§òÁâπ‰ºë\n';
                    data.users.forEach(u => {
                        const usedLeave = data.leaves.filter(l => l.userId === u.id && l.type === 'Áâπ‰ºë' && l.status === 'Â∑≤Ê†∏ÂáÜ').length;
                        csv += `${u.id},${u.name},${u.region},${u.department},${u.position},${u.email},${u.phone},${u.birthday},${u.shift.join('/')},${u.annualLeave},${usedLeave},${u.annualLeave - usedLeave}\n`;
                    });
                    filename = '‰∫∫Âì°ÁÆ°ÁêÜ.csv';
                } else if (type === 'vacation') {
                    csv = 'Âì°Â∑•‰ª£Ëôü,ÂßìÂêç,Âú∞ÂçÄ,ÈÉ®ÈñÄ,Áè≠Âà•,';
                    const days = getMonthDays(selectedMonth);
                    days.forEach(day => {
                        csv += `${day.getMonth()+1}/${day.getDate()},`;
                    });
                    csv += 'Á∏ΩË´ãÂÅáÂ§©Êï∏\n';
                    
                    data.users.forEach(user => {
                        const userLeaves = data.leaves.filter(l => l.userId === user.id && l.status === 'Â∑≤Ê†∏ÂáÜ');
                        csv += `${user.id},${user.name},${user.region},${user.department},${user.shift.join('/')},`;
                        days.forEach(day => {
                            const dateStr = day.toISOString().split('T')[0];
                            const leave = userLeaves.find(l => dateStr >= l.startDate && dateStr <= l.endDate);
                            csv += `${leave ? leave.type : ''},`;
                        });
                        csv += `${userLeaves.filter(l => new Date(l.startDate).getMonth() === selectedMonth.getMonth()).length}\n`;
                    });
                    filename = `‰ºëÂÅáË°®_${selectedMonth.getFullYear()}Âπ¥${selectedMonth.getMonth()+1}Êúà.csv`;
                } else if (type === 'compensatory') {
                    csv = 'Âì°Â∑•‰ª£Ëôü,ÂßìÂêç,Âú∞ÂçÄ,ÈÉ®ÈñÄ,Ë£ú‰ºë(ÊôÇ)Â∑≤‰ΩøÁî®,Ë£ú‰ºë(Â§©)Â∑≤‰ΩøÁî®\n';
                    data.users.forEach(u => {
                        const compHours = data.leaves.filter(l => l.userId === u.id && l.type === 'Ë£ú‰ºë(ÊôÇ)' && l.status === 'Â∑≤Ê†∏ÂáÜ');
                        const compDays = data.leaves.filter(l => l.userId === u.id && l.type === 'Ë£ú‰ºë(Â§©)' && l.status === 'Â∑≤Ê†∏ÂáÜ');
                        const totalHours = compHours.reduce((sum, l) => sum + (l.hours || 0), 0);
                        csv += `${u.id},${u.name},${u.region},${u.department},${totalHours},${compDays.length}\n`;
                    });
                    filename = 'Ë£ú‰ºëË°®.csv';
                } else if (type === 'schedule') {
                    csv = 'Êó•Êúü,Ê®ôÈ°å,ÂÖßÂÆπ\n';
                    if (data.schedules && data.schedules.length > 0) {
                        data.schedules.forEach(s => {
                            csv += `${s.date},${s.title || ''},${s.content || ''}\n`;
                        });
                    } else {
                        csv += 'ÁõÆÂâçÊ≤íÊúâÊéíÁ®ãË≥áÊñô\n';
                    }
                    filename = 'ÊéíÁ®ãË°®.csv';
                } else if (type === 'leaves') {
                    csv = 'Áî≥Ë´ãÊó•Êúü,Âì°Â∑•‰ª£Ëôü,ÂßìÂêç,Âú∞ÂçÄ,ÈÉ®ÈñÄ,ÂÅáÂà•,ÈñãÂßãÊó•Êúü,ÁµêÊùüÊó•Êúü,ÊôÇÊï∏,‰∫ãÁî±,ÁãÄÊÖã,ÂØ©Ê†∏‰∫∫,ÂØ©Ê†∏ÊôÇÈñì\n';
                    data.leaves.forEach(l => {
                        const user = data.users.find(u => u.id === l.userId);
                        csv += `${new Date(l.submittedAt).toLocaleDateString('zh-TW')},${user?.id || ''},${l.userName},${l.region},${l.department},${l.type},${l.startDate},${l.endDate},${l.hours},${l.reason},${l.status},${l.approvedBy || ''},${l.approvedAt ? new Date(l.approvedAt).toLocaleDateString('zh-TW') : ''}\n`;
                    });
                    filename = 'Ë´ãÂÅáÁ¥ÄÈåÑ.csv';
                } else if (type === 'annual') {
                    csv = 'Âì°Â∑•‰ª£Ëôü,ÂßìÂêç,Âú∞ÂçÄ,ÈÉ®ÈñÄ,ËÅ∑Á®±,Á∏ΩÁâπ‰ºëÂ§©Êï∏,Â∑≤‰ΩøÁî®Â§©Êï∏,Ââ©È§òÂ§©Êï∏,‰ΩøÁî®Êó•ÊúüÊòéÁ¥∞\n';
                    data.users.forEach(u => {
                        const annualLeaves = data.leaves.filter(l => l.userId === u.id && l.type === 'Áâπ‰ºë' && l.status === 'Â∑≤Ê†∏ÂáÜ');
                        const usedDays = annualLeaves.length;
                        const dates = annualLeaves.map(l => `${l.startDate}~${l.endDate}`).join('; ');
                        csv += `${u.id},${u.name},${u.region},${u.department},${u.position},${u.annualLeave},${usedDays},${u.annualLeave - usedDays},"${dates}"\n`;
                    });
                    filename = 'Áâπ‰ºëÁ∏ΩË¶Ω.csv';
                }
                
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            };

            const getMonthDays = (date) => {
                const days = [];
                const year = date.getFullYear();
                const month = date.getMonth();
                const lastDay = new Date(year, month + 1, 0).getDate();
                
                for (let d = 1; d <= lastDay; d++) {
                    days.push(new Date(year, month, d));
                }
                return days;
            };

            const isHoliday = (date) => {
                const dateStr = date.toISOString().split('T')[0];
                return holidays2026.find(h => h.date === dateStr);
            };

            const isWeekend = (date) => {
                return date.getDay() === 0 || date.getDay() === 6;
            };

             const isWithinOpenRange = (date) => {
                const dateStr = date.toISOString().split('T')[0];
                const { openStart, openEnd } = data.vacationSettings;
                if (!openStart || !openEnd) return false;
                return dateStr >= openStart && dateStr <= openEnd;
            };

            const handleVacationSettingChange = (field, value) => {
                setData(prev => ({
                    ...prev,
                    vacationSettings: {
                        ...prev.vacationSettings,
                        [field]: value
                    }
                }));
            };

             const vacationMarkerOptions = [
                { value: '‚ñ≤-black', label: '‚ñ≤ ÈªëËâ≤', symbol: '‚ñ≤', textClass: 'text-gray-900', activeClass: 'border-gray-800 bg-gray-100' },
                { value: '‚ñ≤-red', label: '‚ñ≤ Á¥ÖËâ≤', symbol: '‚ñ≤', textClass: 'text-red-600', activeClass: 'border-red-500 bg-red-50' },
                { value: '‚òÖ-black', label: '‚òÖ ÈªëËâ≤', symbol: '‚òÖ', textClass: 'text-gray-900', activeClass: 'border-gray-800 bg-gray-100' },
                { value: '‚òÖ-red', label: '‚òÖ Á¥ÖËâ≤', symbol: '‚òÖ', textClass: 'text-red-600', activeClass: 'border-red-500 bg-red-50' }
            ];

            const getMarkerDisplay = (marker) => {
                if (!marker) return null;
                if (marker.includes('-')) {
                    const [symbol, color] = marker.split('-');
                    return {
                        symbol,
                        className: color === 'red' ? 'text-red-600 font-bold' : 'text-gray-900 font-bold'
                    };
                }
                if (marker === '‚òÖ') {
                    return { symbol: '‚òÖ', className: 'text-red-600 font-bold' };
                }
                return { symbol: marker, className: 'text-gray-900 font-bold' };
            };
            
            const handleToggleVacation = (userId, dateStr) => {
                if (!data.vacationSettings.openStart || !data.vacationSettings.openEnd) return;
                const isOpen = dateStr >= data.vacationSettings.openStart && dateStr <= data.vacationSettings.openEnd;
                if (!isOpen) return;
                if (currentUser.id !== userId) return;
                setData(prev => {
                    const userSchedule = prev.vacationSchedule[userId] || {};
                    const currentMarker = userSchedule[dateStr];
                    const nextMarker = currentMarker === selectedVacationMarker ? '' : selectedVacationMarker;
                    return {
                        ...prev,
                        vacationSchedule: {
                            ...prev.vacationSchedule,
                            [userId]: {
                                ...userSchedule,
                                [dateStr]: nextMarker
                            }
                        }
                    };
                });
            };

            const getWorkingCount = (date) => {
                const dateStr = date.toISOString().split('T')[0];
                const onLeave = data.leaves.filter(l => 
                    l.status === 'Â∑≤Ê†∏ÂáÜ' && 
                    dateStr >= l.startDate && 
                    dateStr <= l.endDate
                ).length;
                return data.users.length - onLeave;
            };

            const handleResetData = () => {
                if (window.confirm('Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâË≥áÊñôÂóé?ÈÄôÂ∞áÊ∏ÖÈô§ÊâÄÊúâÂì°Â∑•ÂíåË´ãÂÅáÁ¥ÄÈåÑ!')) {
                    localStorage.removeItem('leaveSystemData');
                    window.location.reload();
                }
            };

            if (!currentUser) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4 text-base md:text-lg">
                        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg">
                            <div className="text-center mb-8">
                                <div className="bg-indigo-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Users size={32} className="text-white" />
                                </div>
                                <h1 className="text-3xl font-bold text-gray-800">Âì°Â∑•ÂÅáÂã§Á≥ªÁµ±</h1>
                                <p className="text-gray-500 mt-2">Ë´ã‰ΩøÁî®Â∏≥ËôüÂØÜÁ¢ºÁôªÂÖ•</p>
                            </div>
                            
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <label className="block text-sm md:text-base font-medium text-gray-700 mb-2">Â∏≥Ëôü</label>
                                    <input
                                        type="text"
                                        value={loginForm.username}
                                        onChange={(e) => setLoginForm({...loginForm, username: e.target.value})}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg"
                                        required
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm md:text-base font-medium text-gray-700 mb-2">ÂØÜÁ¢º</label>
                                    <input
                                        type="password"
                                        value={loginForm.password}
                                        onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg"
                                        required
                                    />
                                </div>
                                
                                <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700">
                                    ÁôªÂÖ•
                                </button>
                            </form>
                            
                           <div className="mt-6 p-4 bg-blue-50 rounded-lg text-sm md:text-base">
                                <p className="font-medium">Ê∏¨Ë©¶Â∏≥Ëôü:</p>
                                <p>ÁÆ°ÁêÜÂì° - admin / admin123</p>
                                <p>Âì°Â∑• - user001 / pass123</p>
                            </div>
                            
                            <div className="mt-4">
                                <button 
                                    onClick={handleResetData}
                                    className="w-full px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 text-sm md:text-base"
                                >
                                    üîÑ ÈáçÁΩÆÁ≥ªÁµ±Ë≥áÊñô
                                </button>
                                <p className="text-xs text-gray-500 text-center mt-2">
                                    Â¶ÇÊûúÁÑ°Ê≥ïÁôªÂÖ•,Ë´ãÈªûÊìäÊ≠§ÊåâÈàïÈáçÁΩÆ
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 text-base md:text-lg">
                    <div className="fixed top-0 left-0 right-0 z-30 bg-white">
                    <nav className="bg-white shadow-sm border-b">
                     <div className="max-w-screen-2xl mx-auto px-4 py-4">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center space-x-3">
                                    <div className="bg-indigo-600 w-10 h-10 rounded-lg flex items-center justify-center">
                                        <Users size={24} className="text-white" />
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-bold">Âì°Â∑•ÂÅáÂã§Á≥ªÁµ±</h1>
                                       <p className="text-sm md:text-base text-gray-500">Ê≠°Ëøé, {currentUser.name}</p>
                                    </div>
                                </div>
                                
                                <div className="flex items-center space-x-4">
                                    <div className="text-right">
                                        <p className="text-sm md:text-base text-gray-600">ÂèØ‰ºëÁâπ‰ºë</p>
                                        <p className="text-lg font-bold text-indigo-600">
                                            {currentUser.annualLeave} Â§©
                                        </p>
                                    </div>
                                    <button onClick={handleLogout} className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                                        ÁôªÂá∫
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <div className="bg-white border-b">
                        <div className="max-w-screen-2xl mx-auto px-4">
                            <div className="flex space-x-1">
                                {[
                                    { id: 'management', label: '‰∫∫Âì°ÁÆ°ÁêÜ', icon: Users, admin: true },
                                    { id: 'vacation', label: '‰ºëÂÅáË°®', icon: Calendar },
                                    { id: 'compensatory', label: 'Ë£ú‰ºëË°®', icon: Clock },
                                    { id: 'schedule', label: 'ÊéíÁ®ãË°®', icon: Clipboard },
                                    { id: 'leave', label: 'Ë´ãÂÅá', icon: FileText },
                                    { id: 'annual', label: 'Áâπ‰ºë', icon: Calendar }
                                ].map(tab => {
                                    if (tab.admin && !currentUser.isAdmin) return null;
                                    const Icon = tab.icon;
                                    return (
                                        <button
                                            key={tab.id}
                                            onClick={() => setActiveTab(tab.id)}
                                            className={`flex items-center space-x-2 px-6 py-3 border-b-2 ${
                                                activeTab === tab.id ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-600'
                                            }`}
                                        >
                                            <Icon size={18} />
                                            <span>{tab.label}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                   </div>
                    
                    <div className="max-w-screen-2xl mx-auto px-4 py-6 pt-40">
                        {activeTab === 'management' && currentUser.isAdmin && (
                            <div className="space-y-4">
                                <div className="flex justify-between">
                                    <h2 className="text-2xl font-bold">‰∫∫Âì°ÁÆ°ÁêÜ</h2>
                                    <div className="flex space-x-2">
                                        <button 
                                            onClick={() => setShowAddUser(!showAddUser)} 
                                            className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                        >
                                            {showAddUser ? 'ÂèñÊ∂àÊñ∞Â¢û' : '+ Êñ∞Â¢ûÂì°Â∑•'}
                                        </button>
                                        <button onClick={() => exportToCSV('users')} className="px-4 py-2 bg-green-600 text-white rounded-lg">
                                            ÂåØÂá∫Excel
                                        </button>
                                    </div>
                                </div>

                                {showAddUser && (
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">{editingUser ? 'Á∑®ËºØÂì°Â∑•' : 'Êñ∞Â¢ûÂì°Â∑•'}</h3>
                                        <form onSubmit={handleAddUser} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">Âì°Â∑•‰ª£Ëôü *</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.id}
                                                    onChange={(e) => setNewUserForm({...newUserForm, id: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                    placeholder="‰æãÂ¶Ç: E003"
                                                    disabled={editingUser}
                                                    required
                                                />
                                                <p className="text-xs text-gray-500 mt-1">Ë´ãËº∏ÂÖ•ÂîØ‰∏ÄÁöÑÂì°Â∑•‰ª£Ëôü</p>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">Â∏≥Ëôü *</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.username}
                                                    onChange={(e) => setNewUserForm({...newUserForm, username: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                    placeholder="ÁôªÂÖ•Áî®Â∏≥Ëôü"
                                                    required
                                                />
                                            </div>
                                            
                                            <div>
                                                 <label className="block text-sm md:text-base font-medium mb-1">ÂØÜÁ¢º *</label>
                                                <input
                                                    type="password"
                                                    value={newUserForm.password}
                                                    onChange={(e) => setNewUserForm({...newUserForm, password: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                    required
                                                />
                                            </div>
                                            
                                            <div>
                                               <label className="block text-sm md:text-base font-medium mb-1">ÂßìÂêç *</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.name}
                                                    onChange={(e) => setNewUserForm({...newUserForm, name: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                    required
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">Âú∞ÂçÄ</label>
                                                <select
                                                    value={newUserForm.region}
                                                    onChange={(e) => setNewUserForm({...newUserForm, region: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                >
                                                    {regionOptions.map(region => (
                                                        <option key={region}>{region}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">ÈÉ®ÈñÄ</label>
                                                <select
                                                    value={newUserForm.department}
                                                    onChange={(e) => setNewUserForm({...newUserForm, department: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                >
                                                     {departmentOptions.map(department => (
                                                        <option key={department}>{department}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">ËÅ∑Á®±</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.position}
                                                    onChange={(e) => setNewUserForm({...newUserForm, position: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">Email</label>
                                                <input
                                                    type="email"
                                                    value={newUserForm.email}
                                                    onChange={(e) => setNewUserForm({...newUserForm, email: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">ÈõªË©±</label>
                                                <input
                                                    type="tel"
                                                    value={newUserForm.phone}
                                                    onChange={(e) => setNewUserForm({...newUserForm, phone: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                    placeholder="0912-345-678"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">ÁîüÊó• (Êúà/Êó•)</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.birthday}
                                                    onChange={(e) => setNewUserForm({...newUserForm, birthday: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                    placeholder="‰æãÂ¶Ç: 05/15 "
                                                />
                                                <p className="text-xs text-gray-500 mt-1">Ê†ºÂºè: Êúà/Êó• (‰∏çÈúÄË¶ÅËº∏ÂÖ•Âπ¥‰ªΩ)</p>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">Áè≠Âà•</label>
                                                <div className="flex space-x-4 mt-2">
                                                    <label className="flex items-center space-x-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={newUserForm.shift.includes('Êó©')}
                                                            onChange={() => toggleShift('Êó©')}
                                                            className="w-4 h-4"
                                                        />
                                                        <span>Êó©Áè≠</span>
                                                    </label>
                                                    <label className="flex items-center space-x-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={newUserForm.shift.includes('Êôö')}
                                                            onChange={() => toggleShift('Êôö')}
                                                            className="w-4 h-4"
                                                        />
                                                        <span>ÊôöÁè≠</span>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">Âπ¥Â∫¶Áâπ‰ºëÂ§©Êï∏</label>
                                                <input
                                                    type="number"
                                                    value={newUserForm.annualLeave}
                                                    onChange={(e) => setNewUserForm({...newUserForm, annualLeave: parseInt(e.target.value) || 0})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                    min="0"
                                                    max="30"
                                                />
                                            </div>
                                            
                                            <div className="md:col-span-2">
                                                <label className="flex items-center space-x-2">
                                                    <input
                                                        type="checkbox"
                                                        checked={newUserForm.isAdmin}
                                                        onChange={(e) => setNewUserForm({...newUserForm, isAdmin: e.target.checked})}
                                                        className="w-4 h-4"
                                                    />
                                                     <span className="text-sm md:text-base font-medium">Ë®≠ÁÇ∫ÁÆ°ÁêÜÂì°</span>
                                                    <span className="text-xs text-gray-500">(ÁÆ°ÁêÜÂì°ÂèØ‰ª•ÁÆ°ÁêÜÊâÄÊúâÂì°Â∑•ÂíåÂØ©Ê†∏Ë´ãÂÅá)</span>
                                                </label>
                                            </div>
                                            
                                           {newUserForm.isAdmin && (
                                                <div className="md:col-span-2 rounded-lg border border-indigo-100 bg-indigo-50 p-4">
                                                    <div className="flex items-center justify-between">
                                                        <h4 className="text-sm md:text-base font-semibold text-indigo-700">Ê¨äÈôêÁÆ°ÁêÜ</h4>
                                                        <span className="text-xs text-gray-500">ÂÉÖÂãæÈÅ∏ÁöÑÂú∞ÂçÄ/ÈÉ®ÈñÄÂèØÂØ©Ê†∏ÊàñÁ∑®ËºØÂì°Â∑•Ë≥áÊñô</span>
                                                    </div>
                                                     <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        <div>
                                                            <p className="text-sm md:text-base font-medium text-gray-700 mb-2">Âú∞ÂçÄ</p>
                                                            <div className="space-y-2">
                                                                {regionOptions.map(region => (
                                                                    <label key={region} className="flex items-center space-x-2 text-sm md:text-base">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={newUserForm.permissionRegions.includes(region)}
                                                                            onChange={() => togglePermission('region', region)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>{region}</span>
                                                                    </label>
                                                                ))}
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <p className="text-sm md:text-base font-medium text-gray-700 mb-2">ÈÉ®ÈñÄ</p>
                                                            <div className="space-y-2">
                                                                {departmentOptions.map(department => (
                                                                    <label key={department} className="flex items-center space-x-2 text-sm md:text-base">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={newUserForm.permissionDepartments.includes(department)}
                                                                            onChange={() => togglePermission('department', department)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>{department}</span>
                                                                    </label>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                           )}
                                            
                                            <div className="md:col-span-2 flex space-x-2">
                                                <button 
                                                    type="submit" 
                                                    className="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700"
                                                >
                                                    {editingUser ? 'Êõ¥Êñ∞Âì°Â∑•' : 'Á¢∫Ë™çÊñ∞Â¢û'}
                                                </button>
                                                <button 
                                                    type="button"
                                                    onClick={() => {
                                                        setShowAddUser(false);
                                                        setEditingUser(null);
                                                        setNewUserForm({
                                                            id: '',
                                                            username: '',
                                                            password: '',
                                                            name: '',
                                                            region: regionOptions[0],
                                                            department: departmentOptions[0],
                                                            position: 'Â∞àÂì°',
                                                            email: '',
                                                            phone: '',
                                                            birthday: '',
                                                            shift: [],
                                                            annualLeave: 10,
                                                            isAdmin: false,
                                                            permissionRegions: [...regionOptions],
                                                            permissionDepartments: [...departmentOptions]
                                                        });
                                                    }}
                                                    className="px-6 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300"
                                                >
                                                    ÂèñÊ∂à
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                )}

                                <div className="bg-white rounded-lg shadow overflow-x-auto">
                                    <table className="w-full">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-4 py-3 text-left text-xs">Âì°Â∑•‰ª£Ëôü</th>
                                                <th className="px-4 py-3 text-left text-xs">ÂßìÂêç</th>
                                                <th className="px-4 py-3 text-left text-xs">Âú∞ÂçÄ</th>
                                                <th className="px-4 py-3 text-left text-xs">ÈÉ®ÈñÄ</th>
                                                <th className="px-4 py-3 text-left text-xs">ËÅ∑Á®±</th>
                                                <th className="px-4 py-3 text-left text-xs">Email</th>
                                                <th className="px-4 py-3 text-left text-xs">ÈõªË©±</th>
                                                <th className="px-4 py-3 text-left text-xs">Áè≠Âà•</th>
                                                <th className="px-4 py-3 text-left text-xs">Êìç‰Ωú</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.users.map(user => {
                                                const canManage = canManageUser(user);
                                                return (
                                                    <tr key={user.id}>
                                                        <td className="px-4 py-3">{user.id}</td>
                                                        <td className="px-4 py-3">{user.name}</td>
                                                        <td className="px-4 py-3">{user.region}</td>
                                                        <td className="px-4 py-3">{user.department}</td>
                                                        <td className="px-4 py-3">{user.position}</td>
                                                        <td className="px-4 py-3">{user.email}</td>
                                                        <td className="px-4 py-3">{user.phone}</td>
                                                        <td className="px-4 py-3">
                                                            <div className="flex space-x-1">
                                                                {user.shift.includes('Êó©') && (
                                                                    <span className="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">Êó©</span>
                                                                )}
                                                                {user.shift.includes('Êôö') && (
                                                                    <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">Êôö</span>
                                                                )}
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <div className="flex space-x-2">
                                                                <button 
                                                                    onClick={() => canManage && handleEditUser(user)} 
                                                                    className={`text-blue-600 ${canManage ? 'hover:text-blue-800' : 'opacity-40 cursor-not-allowed'}`}
                                                                    title={canManage ? 'Á∑®ËºØ' : 'ÁÑ°Ê¨äÈôêÁ∑®ËºØÊ≠§Âì°Â∑•'}
                                                                    disabled={!canManage}
                                                                >
                                                                    <Edit2 size={16} />
                                                                </button>
                                                                <button
                                                                    onClick={() => canManage && handleDeleteUser(user.id)}
                                                                    className={`text-red-600 ${canManage ? 'hover:text-red-800' : 'opacity-40 cursor-not-allowed'}`}
                                                                    title={canManage ? 'Âà™Èô§' : 'ÁÑ°Ê¨äÈôêÂà™Èô§Ê≠§Âì°Â∑•'}
                                                                    disabled={!canManage}
                                                                >
                                                                    <Trash2 size={16} />
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div className="bg-white rounded-lg shadow p-4">
                                    <h3 className="text-lg font-bold mb-4">Êìç‰ΩúÁ¥ÄÈåÑ</h3>
                                    <div className="space-y-2 max-h-64 overflow-y-auto">
                                        {data.auditLogs.slice(-10).reverse().map((log, idx) => (
                                            <div key={idx} className="text-sm md:text-base p-2 bg-gray-50 rounded">
                                                <span className="text-gray-500">{new Date(log.timestamp).toLocaleString('zh-TW')}</span>
                                                {' - '}
                                                <span className="font-medium">{log.user}</span>
                                                {' '}
                                                <span className="text-indigo-600">{log.action}</span>
                                                {' - '}
                                                <span>{log.details}</span>
                                            </div>
                                        ))}
                                        {data.auditLogs.length === 0 && (
                                            <p className="text-center text-gray-500 py-4">ÁõÆÂâçÊ≤íÊúâÊìç‰ΩúÁ¥ÄÈåÑ</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'vacation' && (
                            <div className="space-y-4">
                                {/* ÂèØ‰ºëÂ§©Êï∏È°ØÁ§∫ */}
                                  <div className="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-lg p-4 text-white">
                                    <div>
                                        <h3 className="text-base opacity-90">ÊàëÁöÑÂèØ‰ºëÂ§©Êï∏</h3>
                                        <p className="text-3xl font-bold mt-1">{currentUser.annualLeave - (data.leaves.filter(l => l.userId === currentUser.id && l.type === 'Áâπ‰ºë' && l.status === 'Â∑≤Ê†∏ÂáÜ').length)} Â§©</p>
                                        <p className="text-xs opacity-80 mt-1">Â∑≤‰ΩøÁî®: {data.leaves.filter(l => l.userId === currentUser.id && l.type === 'Áâπ‰ºë' && l.status === 'Â∑≤Ê†∏ÂáÜ').length} Â§©</p>
                                    </div>
                                </div>

                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">‰ºëÂÅáË°®</h2>
                                    <div className="flex space-x-2">
                                        <select
                                            value={filterRegion}
                                            onChange={(e) => setFilterRegion(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>Âú∞ÂçÄ</option>
                                            <option>Êñ∞Á´πÂçÄ</option>
                                            <option>Âè∞‰∏≠ÂçÄ</option>
                                            <option>ÂòâÁæ©ÂçÄ</option>
                                        </select>
                                        <select
                                            value={filterDepartment}
                                            onChange={(e) => setFilterDepartment(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>ÈÉ®ÈñÄ</option>
                                            <option>ÁÆ°ÁêÜÈÉ®</option>
                                            <option>TSE</option>
                                            <option>FAE</option>
                                            <option>Êñ∞Â†¥</option>
                                            <option>ÂÄâÁÆ°</option>
                                            <option>RD</option>
                                            <option>Á∑ö‰∏äÂÆ¢Êúç</option>
                                        </select>
                                        <select
                                            value={filterShift}
                                            onChange={(e) => setFilterShift(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>Áè≠Âà•</option>
                                            <option>Êó©</option>
                                            <option>Êôö</option>
                                        </select>
                                        <button
                                            onClick={() => exportToCSV('vacation')}
                                            className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                        >
                                            <Download size={18} />
                                            <span>ÂåØÂá∫Excel</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="bg-white rounded-lg shadow p-4">
                                             {currentUser.isAdmin && (
                                        <div className="mb-4 rounded-lg border border-indigo-100 bg-indigo-50 p-3">
                                            <p className="text-sm md:text-base font-medium text-indigo-700 mb-2">Áè≠Ë°®ÈñãÊîæÊó•ÊúüË®≠ÂÆö (ÁÆ°ÁêÜÂì°)</p>
                                            <div className="flex flex-wrap gap-3 items-center">
                                                <div className="flex items-center space-x-2">
                                                   <label className="text-sm md:text-base text-gray-700">ÈñãÂßã</label>
                                                    <input
                                                        type="date"
                                                        value={data.vacationSettings.openStart}
                                                        onChange={(e) => handleVacationSettingChange('openStart', e.target.value)}
                                                        className="px-3 py-2 border rounded-lg"
                                                    />
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                     <label className="text-sm md:text-base text-gray-700">ÁµêÊùü</label>
                                                    <input
                                                        type="date"
                                                        value={data.vacationSettings.openEnd}
                                                        onChange={(e) => handleVacationSettingChange('openEnd', e.target.value)}
                                                        className="px-3 py-2 border rounded-lg"
                                                    />
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                    <label className="text-sm md:text-base text-gray-700">Êú¨ÊúàÂèØ‰ºëÂ§©Êï∏</label>
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        value={data.vacationSettings.monthlyVacationDays}
                                                        onChange={(e) => handleVacationSettingChange('monthlyVacationDays', e.target.value)}
                                                        className="w-24 px-3 py-2 border rounded-lg"
                                                    />
                                                    <span className="text-sm md:text-base text-gray-600">Â§©</span>
                                                </div>
                                                <span className="text-xs text-gray-600">
                                                    ÈñãÊîæÊúüÈñìÂÖßÂì°Â∑•ÂèØËá™Ë°åÁ∑®ËºØ‰ºëÂÅáÊó•
                                                </span>
                                            </div>
                                        </div>
                                    )}
                                    <div className="mb-4 flex flex-wrap items-center gap-3 text-sm md:text-base text-gray-600">
                                        <div className="flex flex-wrap items-center gap-2">
                                            <span className="font-medium text-gray-700">‰ºëÂÅáÁ¨¶Ëôü:</span>
                                           {vacationMarkerOptions.map(option => (
                                                <button
                                                    key={option.value}
                                                    onClick={() => setSelectedVacationMarker(option.value)}
                                                    className={`px-2 py-1 rounded border ${selectedVacationMarker === option.value ? option.activeClass : 'border-gray-200'}`}
                                                >
                                                    <span className={`${option.textClass} font-bold`}>{option.symbol}</span> {option.label.split(' ')[1]}
                                                </button>
                                            ))}
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            {data.vacationSettings.openStart && data.vacationSettings.openEnd
                                                ? `ÈñãÊîæÊúüÈñì: ${data.vacationSettings.openStart} ~ ${data.vacationSettings.openEnd}`
                                                : 'Â∞öÊú™Ë®≠ÂÆöÈñãÊîæÊó•Êúü'}
                                        </div>
                                          <div className="text-sm md:text-base text-gray-600">
                                            Êú¨ÊúàÂèØ‰ºë: {data.vacationSettings.monthlyVacationDays || 'Êú™Ë®≠ÂÆö'} Â§©
                                        </div>
                                    </div>
                                    <div className="flex justify-between mb-4">
                                        <button onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1))} className="px-4 py-2 bg-gray-100 rounded">
                                            ‰∏äÂÄãÊúà
                                        </button>
                                        <h3 className="text-xl font-bold">
                                            {selectedMonth.getFullYear()}Âπ¥ {selectedMonth.getMonth() + 1}Êúà
                                        </h3>
                                        <button onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1))} className="px-4 py-2 bg-gray-100 rounded">
                                            ‰∏ãÂÄãÊúà
                                        </button>
                                    </div>

                                    <div>
                                        <table className="w-full border-collapse text-sm md:text-base table-fixed">
                                            <thead>
                                                <tr>
                                                   <th className="border-2 border-gray-400 p-2 bg-gray-100 sticky left-0 z-20 w-28 text-sm md:text-base">ÊòüÊúü</th>
                                                    {getMonthDays(selectedMonth).map(day => {
                                                        const holiday = isHoliday(day);
                                                        const weekend = isWeekend(day);
                                                        const dayName = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'][day.getDay()];
                                                        return (
                                                            <th
                                                                key={`week-${day.toISOString()}`}
                                                                className={`border-2 p-1 text-center text-sm md:text-base font-bold ${
                                                                    holiday ? 'bg-red-200 text-red-900 border-red-400' :
                                                                    weekend ? 'bg-blue-200 text-blue-900 border-blue-400' :
                                                                    'bg-gray-50 border-gray-300'
                                                                }`}
                                                            >
                                                                {dayName}
                                                            </th>
                                                        );
                                                    })}
                                                  <th className="border-2 border-gray-400 p-2 bg-yellow-100 font-bold sticky right-0 z-20 w-24 whitespace-nowrap text-sm md:text-base">Â∑≤ÈÅ∏Â§©Êï∏</th>
                                                </tr>
                                                <tr>
                                                    <th className="border-2 border-gray-400 p-2 bg-gray-100 sticky left-0 z-20 text-sm md:text-base">Êó•Êúü</th>
                                                    {getMonthDays(selectedMonth).map(day => {
                                                        const holiday = isHoliday(day);
                                                        const weekend = isWeekend(day);
                                                        return (
                                                            <th
                                                                key={`date-${day.toISOString()}`}
                                                                 className={`border-2 p-1 text-center text-sm md:text-base font-bold ${
                                                                    holiday ? 'bg-red-200 text-red-900 border-red-400' :
                                                                    weekend ? 'bg-blue-200 text-blue-900 border-blue-400' :
                                                                    'bg-gray-50 border-gray-300'
                                                                }`}
                                                            >
                                                                {day.getDate()}
                                                            </th>
                                                        );
                                                    })}
                                                    <th className="border-2 border-gray-400 p-2 bg-yellow-100 sticky right-0 z-20"></th>
                                                </tr>
                                                <tr>
                                                 <th className="border-2 border-gray-400 p-2 bg-gray-100 sticky left-0 z-20 text-sm md:text-base">ÂúãÂÆöÂÅáÊó•</th>
                                                    {getMonthDays(selectedMonth).map(day => {
                                                        const holiday = isHoliday(day);
                                                        const weekend = isWeekend(day);
                                                        return (
                                                            <th
                                                                key={`note-${day.toISOString()}`}
                                                               className={`border-2 p-1 text-center text-sm md:text-base ${
                                                                    holiday ? 'bg-red-200 text-red-900 border-red-400' :
                                                                    weekend ? 'bg-blue-200 text-blue-900 border-blue-400' :
                                                                    'bg-gray-50 border-gray-300'
                                                                }`}
                                                            >
                                                                {holiday ? holiday.name : ''}
                                                            </th>
                                                        );
                                                    })}
                                                    <th className="border-2 border-gray-400 p-2 bg-yellow-100 sticky right-0 z-20"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {data.users
                                                    .filter(u => 
                                                        (filterRegion === 'ÂÖ®ÈÉ®' || u.region === filterRegion) &&
                                                        (filterDepartment === 'ÂÖ®ÈÉ®' || u.department === filterDepartment) &&
                                                        (filterShift === 'ÂÖ®ÈÉ®' || u.shift.includes(filterShift))
                                                    )
                                                    .map(user => {
                                                        const userLeaves = data.leaves.filter(l => 
                                                            l.userId === user.id && 
                                                            l.status === 'Â∑≤Ê†∏ÂáÜ' &&
                                                            new Date(l.startDate).getMonth() === selectedMonth.getMonth()
                                                        );
                                                        const isCurrentUser = user.id === currentUser.id;
                                                        const markerCount = (data.vacationSchedule[user.id] && Object.values(data.vacationSchedule[user.id]).filter(Boolean).length) || 0;
                                                        
                                                        return (
                                                            <tr key={user.id} className={isCurrentUser ? 'bg-indigo-50' : ''}>
                                                                <td className="border-2 border-gray-400 p-2 font-medium bg-white sticky left-0 z-10">
                                                                    <div>
                                                                        {user.name}
                                                                        {isCurrentUser && <span className="ml-1 text-xs bg-indigo-600 text-white px-2 py-0.5 rounded">Êàë</span>}
                                                                    </div>
                                                                    <div className="text-xs text-gray-500">{user.department}</div>
                                                                    <div className="flex gap-1 mt-1">
                                                                        {user.shift.includes('Êó©') && (
                                                                            <span className="px-1 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded">Êó©</span>
                                                                        )}
                                                                        {user.shift.includes('Êôö') && (
                                                                            <span className="px-1 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">Êôö</span>
                                                                        )}
                                                                    </div>
                                                                </td>
                                                                {getMonthDays(selectedMonth).map(day => {
                                                                    const dateStr = day.toISOString().split('T')[0];
                                                                    const leave = userLeaves.find(l => 
                                                                        dateStr >= l.startDate && dateStr <= l.endDate
                                                                    );
                                                                    const holiday = isHoliday(day);
                                                                    const weekend = isWeekend(day);
                                                                    const customMarker = data.vacationSchedule[user.id]?.[dateStr];
                                                                    const isOpen = isWithinOpenRange(day);
                                                                    const isEditable = isOpen && isCurrentUser;
                                                                    const markerDisplay = getMarkerDisplay(customMarker);
                                                                    
                                                                    return (
                                                                        <td
                                                                            key={day.toISOString()}
                                                                             className={`border p-1 text-center ${
                                                                                leave ? 'bg-orange-100 text-orange-900 font-bold border-orange-300' : 
                                                                                holiday ? 'bg-red-50 border-red-200' :
                                                                                weekend ? 'bg-blue-50 border-blue-200' :
                                                                                     'border-gray-200'
                                                                            } ${isEditable ? 'cursor-pointer hover:bg-indigo-50' : ''}`}
                                                                            onClick={() => handleToggleVacation(user.id, dateStr)}
                                                                            title={isEditable ? 'ÈªûÊìäË®≠ÂÆö‰ºëÂÅáÊ®ôË®ò' : ''}
                                                                        >
                                                                                                                      {leave ? (
                                                                                <span className="text-purple-700 font-semibold">Ë´ã</span>
                                                                            ) : markerDisplay ? (
                                                                                <span className={markerDisplay.className}>
                                                                                    {markerDisplay.symbol}
                                                                                </span>
                                                                            ) : ''}
                                                                        </td>
                                                                    );
                                                                })}
                                                                <td className="border-2 border-gray-400 p-2 text-center font-bold text-base text-indigo-700 bg-yellow-50 sticky right-0 z-10 w-24 whitespace-nowrap">
                                                                    {markerCount}
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                <tr className="bg-green-50">
                                                    <td className="border-2 border-gray-400 p-2 font-bold text-center sticky left-0 z-10 bg-green-100">‰∏äÁè≠‰∫∫Êï∏</td>
                                                    {getMonthDays(selectedMonth).map(day => {
                                                        return (
                                                            <td
                                                                key={`count-${day.toISOString()}`}
                                                                className="border-2 border-gray-300 p-2 text-center font-bold text-green-700 bg-green-50"
                                                            >
                                                                {getWorkingCount(day)}
                                                                </td>
                                                );
                                            })}
                                                    <td className="border-2 border-gray-400 p-2 sticky right-0 z-10 bg-green-100"></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
 
                                    <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                                         <h4 className="font-bold mb-2 text-sm md:text-base">Âúñ‰æãË™™Êòé:</h4>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                                            <div className="flex items-center space-x-2">
                                                <div className="w-4 h-4 bg-red-200 border-2 border-red-400"></div>
                                                <span>ÂúãÂÆöÂÅáÊó•</span>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <div className="w-4 h-4 bg-blue-200 border-2 border-blue-400"></div>
                                                <span>ÈÄ±Êú´</span>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <div className="w-4 h-4 bg-orange-100 border-2 border-orange-300"></div>
                                                 <span>Â∑≤Ê†∏ÂáÜË´ãÂÅá</span>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <div className="w-4 h-4 bg-indigo-50 border-2"></div>
                                                <span>ÊàëÁöÑË≥áÊñô</span>
                                            </div>
                                        </div>
                                       <p className="text-xs text-gray-600 mt-2">üí° ÈñãÊîæÊúüÈñìÂÖßÂèØÈªûÊìäËá™Â∑±ÁöÑÊó•ÊúüË®≠ÂÆö‚ñ≤/‚òÖÔºàÈªëÊàñÁ¥ÖÔºâ</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'leave' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">Ë´ãÂÅáÁî≥Ë´ã</h2>
                                    <button
                                        onClick={() => exportToCSV('leaves')}
                                        className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        <Download size={18} />
                                        <span>ÂåØÂá∫Excel</span>
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">Êñ∞Â¢ûË´ãÂÅá</h3>
                                        <form onSubmit={handleSubmitLeave} className="space-y-4">
                                            <input type="text" value={currentUser.name} disabled className="w-full px-3 py-2 border rounded bg-gray-50" />
                                            
                                            <select value={newLeaveForm.type} onChange={(e) => setNewLeaveForm({...newLeaveForm, type: e.target.value})} className="w-full px-3 py-2 border rounded">
                                                <option>Áâπ‰ºë</option>
                                                <option>ÁóÖÂÅá</option>
                                                <option>‰∫ãÂÅá</option>
                                                <option>ÊóÖÈÅäÂÅá</option>
                                                <option>Âñ™ÂÅá</option>
                                                <option>ÁîüÁêÜÂÅá</option>
                                                <option>Ë£ú‰ºë(ÊôÇ)</option>
                                                <option>Ë£ú‰ºë(Â§©)</option>
                                                <option>Âπ¥ÂÅá</option>
                                            </select>
                                            
                                            <input type="date" value={newLeaveForm.startDate} onChange={(e) => setNewLeaveForm({...newLeaveForm, startDate: e.target.value})} className="w-full px-3 py-2 border rounded" required />
                                            
                                            <input type="date" value={newLeaveForm.endDate} onChange={(e) => setNewLeaveForm({...newLeaveForm, endDate: e.target.value})} className="w-full px-3 py-2 border rounded" required />
                                            
                                            <textarea value={newLeaveForm.reason} onChange={(e) => setNewLeaveForm({...newLeaveForm, reason: e.target.value})} className="w-full px-3 py-2 border rounded" rows="3" required />
                                            
                                            <button type="submit" className="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">
                                                ÈÄÅÂá∫Áî≥Ë´ã
                                            </button>
                                        </form>
                                    </div>

                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">ÊàëÁöÑÁî≥Ë´ã</h3>
                                        <div className="space-y-3">
                                            {data.leaves.filter(l => l.userId === currentUser.id).map(leave => (
                                                <div key={leave.id} className="border rounded p-3">
                                                    <div className="flex justify-between mb-2">
                                                        <span className="font-medium">{leave.type}</span>
                                                        <span className={`px-2 py-1 text-xs rounded ${leave.status === 'Â∑≤Ê†∏ÂáÜ' ? 'bg-green-100' : 'bg-yellow-100'}`}>
                                                            {leave.status}
                                                        </span>
                                                    </div>
                                                     <p className="text-sm md:text-base">{leave.startDate} ~ {leave.endDate}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {currentUser.isAdmin && (
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">ÂæÖÂØ©Ê†∏ (ÁÆ°ÁêÜÂì°)</h3>
                                          <p className="text-xs text-gray-500 mb-3">ÂÉÖÂèØÂØ©Ê†∏ÂÖ∑Ê¨äÈôêÁöÑÂú∞ÂçÄÊàñÈÉ®ÈñÄ</p>
                                        {pendingLeaves.map(leave => {
                                            const canApprove = canApproveLeave(leave);
                                            return (
                                                <div key={leave.id} className="border rounded p-4 mb-3">
                                                    <div className="flex justify-between">
                                                        <div>
                                                            <p className="font-medium">{leave.userName} - {leave.type}</p>
                                                            <p className="text-sm md:text-base">{leave.startDate} ~ {leave.endDate}</p>
                                                            <p className="text-xs text-gray-500">{leave.region} / {leave.department}</p>
                                                        </div>
                                                        <div className="flex space-x-2">
                                                            <button
                                                                onClick={() => canApprove && handleApproveLeave(leave.id, 'Â∑≤Ê†∏ÂáÜ')}
                                                                className={`px-3 py-1 rounded text-white ${canApprove ? 'bg-green-600' : 'bg-gray-300 cursor-not-allowed'}`}
                                                                disabled={!canApprove}
                                                            >
                                                                Ê†∏ÂáÜ
                                                            </button>
                                                            <button
                                                                onClick={() => canApprove && handleApproveLeave(leave.id, 'Â∑≤ÊãíÁµï')}
                                                                className={`px-3 py-1 rounded text-white ${canApprove ? 'bg-red-600' : 'bg-gray-300 cursor-not-allowed'}`}
                                                                disabled={!canApprove}
                                                            >
                                                                ÊãíÁµï
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                             );
                                        })}
                                        {pendingLeaves.length === 0 && (
                                            <p className="text-center text-gray-500 py-4">ÁõÆÂâçÊ≤íÊúâÂæÖÂØ©Ê†∏Áî≥Ë´ã</p>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'annual' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">Áâπ‰ºëÁ∏ΩË¶Ω</h2>
                                    <div className="flex space-x-2">
                                        <select
                                            value={filterRegion}
                                            onChange={(e) => setFilterRegion(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>ÂÖ®ÈÉ®</option>
                                            <option>Êñ∞Á´πÂçÄ</option>
                                            <option>Âè∞‰∏≠ÂçÄ</option>
                                            <option>ÂòâÁæ©ÂçÄ</option>
                                        </select>
                                        <select
                                            value={filterDepartment}
                                            onChange={(e) => setFilterDepartment(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>ÂÖ®ÈÉ®</option>
                                            <option>ÁÆ°ÁêÜÈÉ®</option>
                                            <option>TSE</option>
                                            <option>FAE</option>
                                            <option>Êñ∞Â†¥</option>
                                            <option>ÂÄâÁÆ°</option>
                                            <option>RD</option>
                                            <option>Á∑ö‰∏äÂÆ¢Êúç</option>
                                        </select>
                                        <button
                                            onClick={() => exportToCSV('annual')}
                                            className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                        >
                                            <Download size={18} />
                                            <span>ÂåØÂá∫Excel</span>
                                        </button>
                                    </div>
                                </div>
                                <div className="bg-white rounded-lg shadow overflow-x-auto">
                                    <table className="w-full">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-4 py-3 text-left">Âì°Â∑•</th>
                                                <th className="px-4 py-3 text-left">ÈÉ®ÈñÄ</th>
                                                <th className="px-4 py-3 text-left">Á∏ΩÁâπ‰ºë</th>
                                                <th className="px-4 py-3 text-left">Â∑≤‰ΩøÁî®</th>
                                                <th className="px-4 py-3 text-left">Ââ©È§ò</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.users.map(user => {
                                                const used = data.leaves.filter(l => l.userId === user.id && l.type === 'Áâπ‰ºë' && l.status === 'Â∑≤Ê†∏ÂáÜ').length;
                                                return (
                                                    <tr key={user.id}>
                                                        <td className="px-4 py-3">{user.name}</td>
                                                        <td className="px-4 py-3">{user.department}</td>
                                                        <td className="px-4 py-3">{user.annualLeave} Â§©</td>
                                                        <td className="px-4 py-3">{used} Â§©</td>
                                                        <td className="px-4 py-3">
                                                            <span className="px-2 py-1 bg-green-100 rounded">{user.annualLeave - used} Â§©</span>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* Ë£ú‰ºëË°® */}
                        {activeTab === 'compensatory' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">Ë£ú‰ºëË°®</h2>
                                    <div className="flex space-x-2">
                                        <select
                                            value={filterRegion}
                                            onChange={(e) => setFilterRegion(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>ÂÖ®ÈÉ®</option>
                                            <option>Êñ∞Á´πÂçÄ</option>
                                            <option>Âè∞‰∏≠ÂçÄ</option>
                                            <option>ÂòâÁæ©ÂçÄ</option>
                                        </select>
                                        <select
                                            value={filterDepartment}
                                            onChange={(e) => setFilterDepartment(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>ÂÖ®ÈÉ®</option>
                                            <option>ÁÆ°ÁêÜÈÉ®</option>
                                            <option>TSE</option>
                                            <option>FAE</option>
                                            <option>Êñ∞Â†¥</option>
                                            <option>ÂÄâÁÆ°</option>
                                            <option>RD</option>
                                            <option>Á∑ö‰∏äÂÆ¢Êúç</option>
                                        </select>
                                        <button
                                            onClick={() => exportToCSV('compensatory')}
                                            className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                        >
                                            <Download size={18} />
                                            <span>ÂåØÂá∫Excel</span>
                                        </button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    {/* Êú¨ÊúàÁµ±Ë®à */}
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">Êú¨ÊúàË£ú‰ºëÁµ±Ë®à</h3>
                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left text-xs">Âì°Â∑•</th>
                                                        <th className="px-4 py-3 text-left text-xs">ÈÉ®ÈñÄ</th>
                                                        <th className="px-4 py-3 text-left text-xs">Ë£ú‰ºë(ÊôÇ)</th>
                                                        <th className="px-4 py-3 text-left text-xs">Ë£ú‰ºë(Â§©)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {data.users
                                                        .filter(u => 
                                                            (filterRegion === 'ÂÖ®ÈÉ®' || u.region === filterRegion) &&
                                                            (filterDepartment === 'ÂÖ®ÈÉ®' || u.department === filterDepartment)
                                                        )
                                                        .map(user => {
                                                            const thisMonth = new Date().getMonth();
                                                            const compHours = data.leaves.filter(l => 
                                                                l.userId === user.id && 
                                                                l.type === 'Ë£ú‰ºë(ÊôÇ)' && 
                                                                l.status === 'Â∑≤Ê†∏ÂáÜ' &&
                                                                new Date(l.startDate).getMonth() === thisMonth
                                                            );
                                                            const compDays = data.leaves.filter(l => 
                                                                l.userId === user.id && 
                                                                l.type === 'Ë£ú‰ºë(Â§©)' && 
                                                                l.status === 'Â∑≤Ê†∏ÂáÜ' &&
                                                                new Date(l.startDate).getMonth() === thisMonth
                                                            );
                                                            const totalHours = compHours.reduce((sum, l) => sum + (l.hours || 0), 0);
                                                            
                                                            return (
                                                                <tr key={user.id}>
                                                                   <td className="px-4 py-3 text-sm md:text-base">{user.name}</td>
                                                                    <td className="px-4 py-3 text-sm md:text-base">{user.department}</td>
                                                                    <td className="px-4 py-3 text-sm md:text-base">{totalHours} Â∞èÊôÇ</td>
                                                                    <td className="px-4 py-3 text-sm md:text-base">{compDays.length} Â§©</td>
                                                                </tr>
                                                            );
                                                        })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    {/* ‰∏äÊúàÁµ±Ë®à */}
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">‰∏äÊúàË£ú‰ºëÁµ±Ë®à</h3>
                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left text-xs">Âì°Â∑•</th>
                                                        <th className="px-4 py-3 text-left text-xs">ÈÉ®ÈñÄ</th>
                                                        <th className="px-4 py-3 text-left text-xs">Ë£ú‰ºë(ÊôÇ)</th>
                                                        <th className="px-4 py-3 text-left text-xs">Ë£ú‰ºë(Â§©)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {data.users
                                                        .filter(u => 
                                                            (filterRegion === 'ÂÖ®ÈÉ®' || u.region === filterRegion) &&
                                                            (filterDepartment === 'ÂÖ®ÈÉ®' || u.department === filterDepartment)
                                                        )
                                                        .map(user => {
                                                            const lastMonth = new Date().getMonth() - 1;
                                                            const compHours = data.leaves.filter(l => 
                                                                l.userId === user.id && 
                                                                l.type === 'Ë£ú‰ºë(ÊôÇ)' && 
                                                                l.status === 'Â∑≤Ê†∏ÂáÜ' &&
                                                                new Date(l.startDate).getMonth() === lastMonth
                                                            );
                                                            const compDays = data.leaves.filter(l => 
                                                                l.userId === user.id && 
                                                                l.type === 'Ë£ú‰ºë(Â§©)' && 
                                                                l.status === 'Â∑≤Ê†∏ÂáÜ' &&
                                                                new Date(l.startDate).getMonth() === lastMonth
                                                            );
                                                            const totalHours = compHours.reduce((sum, l) => sum + (l.hours || 0), 0);
                                                            
                                                            return (
                                                                <tr key={user.id}>
                                                                     <td className="px-4 py-3 text-sm md:text-base">{user.name}</td>
                                                                    <td className="px-4 py-3 text-sm md:text-base">{user.department}</td>
                                                                    <td className="px-4 py-3 text-sm md:text-base">{totalHours} Â∞èÊôÇ</td>
                                                                    <td className="px-4 py-3 text-sm md:text-base">{compDays.length} Â§©</td>
                                                                </tr>
                                                            );
                                                        })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                {/* Ë£ú‰ºëÊòéÁ¥∞ */}
                                <div className="bg-white rounded-lg shadow p-6">
                                    <h3 className="text-lg font-bold mb-4">Ë£ú‰ºë‰ΩøÁî®ÊòéÁ¥∞</h3>
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-4 py-3 text-left text-xs">Êó•Êúü</th>
                                                    <th className="px-4 py-3 text-left text-xs">Âì°Â∑•</th>
                                                    <th className="px-4 py-3 text-left text-xs">ÈÉ®ÈñÄ</th>
                                                    <th className="px-4 py-3 text-left text-xs">È°ûÂûã</th>
                                                    <th className="px-4 py-3 text-left text-xs">ÊôÇÊï∏</th>
                                                    <th className="px-4 py-3 text-left text-xs">ÁãÄÊÖã</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {data.leaves
                                                    .filter(l => l.type === 'Ë£ú‰ºë(ÊôÇ)' || l.type === 'Ë£ú‰ºë(Â§©)')
                                                    .sort((a, b) => new Date(b.startDate) - new Date(a.startDate))
                                                    .map(leave => (
                                                        <tr key={leave.id}>
                                                           <td className="px-4 py-3 text-sm md:text-base">{leave.startDate}</td>
                                                            <td className="px-4 py-3 text-sm md:text-base">{leave.userName}</td>
                                                            <td className="px-4 py-3 text-sm md:text-base">{leave.department}</td>
                                                            <td className="px-4 py-3 text-sm md:text-base">{leave.type}</td>
                                                            <td className="px-4 py-3 text-sm md:text-base">{leave.hours}</td>
                                                            <td className="px-4 py-3 text-sm md:text-base">
                                                                <span className={`px-2 py-1 text-xs rounded ${
                                                                    leave.status === 'Â∑≤Ê†∏ÂáÜ' ? 'bg-green-100 text-green-800' :
                                                                    leave.status === 'Â∑≤ÊãíÁµï' ? 'bg-red-100 text-red-800' :
                                                                    'bg-yellow-100 text-yellow-800'
                                                                }`}>
                                                                    {leave.status}
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                {data.leaves.filter(l => l.type === 'Ë£ú‰ºë(ÊôÇ)' || l.type === 'Ë£ú‰ºë(Â§©)').length === 0 && (
                                                    <tr>
                                                        <td colSpan="6" className="px-4 py-8 text-center text-gray-500">
                                                            ÁõÆÂâçÊ≤íÊúâË£ú‰ºëÁ¥ÄÈåÑ
                                                        </td>
                                                    </tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ÊéíÁ®ãË°® */}
                        {activeTab === 'schedule' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">ÊéíÁ®ãË°®</h2>
                                    <button
                                        onClick={() => exportToCSV('schedule')}
                                        className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        <Download size={18} />
                                        <span>ÂåØÂá∫Excel</span>
                                    </button>
                                </div>

                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <button
                                            onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1))}
                                            className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200"
                                        >
                                            ‰∏äÂÄãÊúà
                                        </button>
                                        <h3 className="text-xl font-bold">
                                            {selectedMonth.getFullYear()}Âπ¥ {selectedMonth.getMonth() + 1}Êúà ÊéíÁ®ã
                                        </h3>
                                        <button
                                            onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1))}
                                            className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200"
                                        >
                                            ‰∏ãÂÄãÊúà
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-7 gap-2">
                                        {['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'].map(day => (
                                            <div key={day} className="text-center font-bold py-2 bg-gray-50 rounded">
                                                {day}
                                            </div>
                                        ))}
                                        
                                        {getMonthDays(selectedMonth).map(day => {
                                            const holiday = isHoliday(day);
                                            const weekend = isWeekend(day);
                                            const dateStr = day.toISOString().split('T')[0];
                                            const schedules = data.schedules?.filter(s => s.date === dateStr) || [];
                                            
                                            return (
                                                <div
                                                    key={day.toISOString()}
                                                    className={`min-h-24 p-2 border rounded-lg ${
                                                        holiday ? 'bg-red-50' :
                                                        weekend ? 'bg-blue-50' :
                                                        'bg-white'
                                                    } hover:shadow-md cursor-pointer transition-shadow`}
                                                    onClick={() => {
                                                        const title = prompt('ÊéíÁ®ãÊ®ôÈ°å:');
                                                        const content = prompt('ÊéíÁ®ãÂÖßÂÆπ:');
                                                        if (title && content) {
                                                            setData(prev => ({
                                                                ...prev,
                                                                schedules: [
                                                                    ...(prev.schedules || []),
                                                                    {
                                                                        id: Date.now().toString(),
                                                                        date: dateStr,
                                                                        title,
                                                                        content
                                                                    }
                                                                ]
                                                            }));
                                                        }
                                                    }}
                                                >
                                                   <div className="font-bold text-sm md:text-base mb-1">
                                                        {day.getDate()}
                                                        {holiday && <span className="ml-1 text-xs text-red-600">{holiday.name}</span>}
                                                    </div>
                                                    <div className="space-y-1">
                                                        {schedules.map(schedule => (
                                                            <div key={schedule.id} className="text-xs bg-indigo-100 text-indigo-800 p-1 rounded">
                                                                <div className="font-medium">{schedule.title}</div>
                                                                <div className="text-xs">{schedule.content}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <p className="text-sm md:text-base text-blue-800">
                                        üí° ÈªûÊìäÊó•ÊúüÂèØ‰ª•Êñ∞Â¢ûÊéíÁ®ã„ÄÇÊéíÁ®ãË≥áÊñôÊúÉËá™ÂãïÂÑ≤Â≠ò„ÄÇ
                                    </p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EmployeeLeaveSystem />);
    </script>
</body>
</html>
