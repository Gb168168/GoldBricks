<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>員工假管理系統-8</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide Icons 組件
        const Users = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const Calendar = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const FileText = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
        );

        const Clock = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        );

        const Clipboard = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
            </svg>
        );

        const LogOut = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
        );

        const Download = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const Trash2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        );

        const Edit2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
            </svg>
        );

        const Bell = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
        );

        const regionOptions = ['新竹區', '台中區', '嘉義區'];
        const departmentOptions = ['管理部', 'TSE', 'FAE', '新場', '倉管', 'RD', '線上客服'];

        const firebaseConfig = {
            apiKey: 'AIzaSyDlckNcNvIBOOEO23gHlt7A-H13mUelYqM',
            authDomain: 'goldbricks-38d0a.firebaseapp.com',
            projectId: 'goldbricks-38d0a',
            storageBucket: 'goldbricks-38d0a.firebasestorage.app',
            messagingSenderId: '14002577439',
            appId: '1:14002577439:web:be07d91cab555954afb52a',
            measurementId: 'G-YY69T47198'
        };

        // 保留 Firebase 設定供未來擴充，目前流程未使用 Firebase 驗證。

        // 初始化資料
        const initialData = {
            users: [
                {
                    id: 'E001',
                    username: '001',
                    name: '管理員',
                    region: '新竹區',
                    department: '管理部',
                    position: '經理',
                    email: 'admin@company.com',
                    phone: '0912-345-678',
                    birthday: '1980-01-01',
                    shift: ['早'],
                    isAdmin: true,
                    permissionRegions: [...regionOptions],
                    permissionDepartments: [...departmentOptions],
                    annualLeave: 14,
                    usedAnnualLeave: 0
                },
                {
                    id: 'E002',
                    username: '002',
                    name: '王小明',
                    region: '台中區',
                    department: 'TSE',
                    position: '專員',
                    email: 'wang@company.com',
                    phone: '0923-456-789',
                    birthday: '1990-05-15',
                    shift: ['早', '晚'],
                    isAdmin: false,
                    permissionRegions: [],
                    permissionDepartments: [],
                    annualLeave: 10,
                    usedAnnualLeave: 2
                }
            ],
            leaves: [],
            schedules: [],
            auditLogs: [],
            vacationSettings: {
                openStart: '',
                openEnd: '',
                monthlyVacationDays: ''
            },
            vacationSchedule: {},
            vacationNotes: {}
        };

        // 國定假日資料
        const holidays2026 = [
            { date: '2026-01-01', name: '元旦' },
            { date: '2026-02-15', name: '小年夜' },
            { date: '2026-02-16', name: '除夕' },
            { date: '2026-02-17', name: '初一' },
            { date: '2026-02-18', name: '初二' },
            { date: '2026-02-19', name: '初三' },
            { date: '2026-02-28', name: '和平紀念' },
            { date: '2026-04-04', name: '兒童 節' },
            { date: '2026-04-05', name: '清明 節' },
            { date: '2026-05-01', name: '勞動 節' },
            { date: '2026-06-25', name: '端午 節' },
            { date: '2026-09-28', name: '教師 節' },
            { date: '2026-10-01', name: '中秋 節' },
            { date: '2026-10-10', name: '國慶 日' },
            { date: '2026-10-25', name: '光復 節' },
            { date: '2026-12-25', name: '行憲紀念' }
        ];

        const CURRENT_USER_STORAGE_KEY = 'leaveSystemCurrentUserId';

         const normalizeUserPermissions = (users = []) =>
            users.map(user => {
                if (!user?.isAdmin) {
                    return {
                        ...user,
                        permissionRegions: Array.isArray(user?.permissionRegions) ? user.permissionRegions : [],
                        permissionDepartments: Array.isArray(user?.permissionDepartments) ? user.permissionDepartments : []
                    };
                }

                const savedRegions = Array.isArray(user.permissionRegions) ? user.permissionRegions : [];
                const savedDepartments = Array.isArray(user.permissionDepartments) ? user.permissionDepartments : [];
                const hasExplicitPermissions = savedRegions.length > 0 || savedDepartments.length > 0;

                return {
                    ...user,
                    permissionRegions: hasExplicitPermissions ? savedRegions : [...regionOptions],
                    permissionDepartments: hasExplicitPermissions ? savedDepartments : [...departmentOptions]
                };
            });

        const EmployeeLeaveSystem = () => {
             const [currentUser, setCurrentUser] = useState(() => {
                const savedData = localStorage.getItem('leaveSystemData');
                const savedUserId = localStorage.getItem(CURRENT_USER_STORAGE_KEY);

                if (!savedData || !savedUserId) return initialData.users[0] || null;

                try {
                    const parsed = JSON.parse(savedData);
                    return (parsed.users || []).find(user => user.id === savedUserId) || (parsed.users || [])[0] || initialData.users[0] || null;
                } catch (error) {
                    return initialData.users[0] || null;
                }
            });
            const [activeTab, setActiveTab] = useState('vacation');
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem('leaveSystemData');
                     if (!saved) return initialData;
                const parsed = JSON.parse(saved);
                return {
                    ...initialData,
                    ...parsed,
                    users: normalizeUserPermissions(parsed.users || initialData.users),
                        ...initialData.vacationSettings,
                        ...parsed.vacationSettings
                    },
                    schedules: parsed.schedules || [],
                    vacationSchedule: parsed.vacationSchedule || {},
                    vacationNotes: parsed.vacationNotes || {}
                };
            });

            const [selectedMonth, setSelectedMonth] = useState(new Date(2026, 1)); // 2月
            const [workingViewDate, setWorkingViewDate] = useState(new Date());
            const [filterRegion, setFilterRegion] = useState('全部');
            const [filterDepartment, setFilterDepartment] = useState('全部');
            const [filterShift, setFilterShift] = useState('全部');
            const [selectedAnnualUserId, setSelectedAnnualUserId] = useState('');
            const [selectedVacationMarker, setSelectedVacationMarker] = useState('▲-black');
            const [showVacationSettings, setShowVacationSettings] = useState(false);
            const [newLeaveForm, setNewLeaveForm] = useState({
                type: '特休',
                startDate: '',
                endDate: '',
                reason: '',
                hours: 8
            });
            const [showScheduleModal, setShowScheduleModal] = useState(false);
            const [selectedScheduleDate, setSelectedScheduleDate] = useState('');
            const [scheduleForm, setScheduleForm] = useState({ title: '', content: '' });

            const [showAddUser, setShowAddUser] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [newUserForm, setNewUserForm] = useState({
                id: '',
                username: '',
                name: '',
                region: regionOptions[0],
                department: departmentOptions[0],
                position: '專員',
                email: '',
                phone: '',
                birthday: '',
                shift: [],
                annualLeave: 10,
                isAdmin: false,
                permissionRegions: [...regionOptions],
                permissionDepartments: [...departmentOptions]
            });

            useEffect(() => {
                localStorage.setItem('leaveSystemData', JSON.stringify(data));
            }, [data]);

            useEffect(() => {
                if (currentUser?.id) {
                    localStorage.setItem(CURRENT_USER_STORAGE_KEY, currentUser.id);
                } else {
                    localStorage.removeItem(CURRENT_USER_STORAGE_KEY);
                }
            }, [currentUser]);

           useEffect(() => {
                setData(prev => {
                    const normalizedUsers = normalizeUserPermissions(prev.users || []);
                    const changed = JSON.stringify(normalizedUsers) !== JSON.stringify(prev.users || []);
                    if (!changed) return prev;
                    return {
                        ...prev,
                        users: normalizedUsers
                    };
                });
            }, []);
            useEffect(() => {
                  if (!currentUser?.id) {
                    const defaultUser = data.users[0] || null;
                    if (defaultUser) {
                        setCurrentUser(defaultUser);
                    }
                    return;
                }

                const latestUser = data.users.find(user => user.id === currentUser.id);
                if (!latestUser) {
                    setCurrentUser(data.users[0] || null);
                    setActiveTab('vacation');
                    return;
                }

                if (JSON.stringify(latestUser) !== JSON.stringify(currentUser)) {
                    setCurrentUser(latestUser);
                }
            }, [data.users, currentUser]);

            const handleLogout = async () => {
               setCurrentUser(data.users[0] || null);
               setActiveTab('vacation');
            };

            const handleDeleteUser = (userId) => {
                const user = data.users.find(u => u.id === userId);
                if (!user || !canManageUser(user)) {
                    alert('無權限刪除此員工');
                    return;
                }
                if (window.confirm('確定要刪除此員工嗎?')) {
                    setData(prev => ({
                        ...prev,
                        users: prev.users.filter(u => u.id !== userId),
                        auditLogs: [...prev.auditLogs, {
                            timestamp: new Date().toISOString(),
                            user: currentUser.name,
                            action: '刪除員工',
                            details: user.name
                        }]
                    }));
                }
            };

            const handleEditUser = (user) => {
                if (!canManageUser(user)) {
                    alert('無權限編輯此員工資料');
                    return;
                }
                setEditingUser(user);
                setNewUserForm({
                    id: user.id,
                    username: user.username,
                    name: user.name,
                    region: user.region,
                    department: user.department,
                    position: user.position,
                    email: user.email,
                    phone: user.phone,
                    birthday: user.birthday,
                    shift: user.shift,
                    annualLeave: user.annualLeave,
                    isAdmin: user.isAdmin || false,
                    permissionRegions: Array.isArray(user.permissionRegions) ? user.permissionRegions : [...regionOptions],
                    permissionDepartments: Array.isArray(user.permissionDepartments) ? user.permissionDepartments : [...departmentOptions]
                });
                setShowAddUser(true);
            };

            const handleAddUser = async (e) => {
                e.preventDefault();

                const normalizedId = (newUserForm.id || '').trim();
                const normalizedUsername = (newUserForm.username || '').trim();

                if (!normalizedId) {
                    alert('員工代號為必填!');
                    return;
                }

                const userPayload = {
                    ...newUserForm,
                    id: normalizedId,
                    username: normalizedUsername
                };
                
                if (editingUser) {
                    const targetId = editingUser.id;
                    const nextId = userPayload.id;

                    if (nextId !== targetId && data.users.some(u => u.id === nextId)) {
                        alert('員工代號已存在,請使用其他代號!');
                        return;
                    }

                    if (userPayload.username && data.users.some(u => u.id !== targetId && u.username === userPayload.username)) {
                        alert('帳號已存在,請使用其他帳號!');
                        return;
                    }

                    if (data.users.some(u => u.id !== targetId && u.email === userPayload.email)) {
                        alert('Email 已存在,請使用其他 Email!');
                        return;
                    }

                    setData(prev => {
                        const updatedUsers = prev.users.map(u =>
                            u.id === targetId
                                ? { ...userPayload, usedAnnualLeave: u.usedAnnualLeave }
                                : u
                         );

                        if (targetId === nextId) {
                            return {
                                ...prev,
                                users: updatedUsers,
                                auditLogs: [...prev.auditLogs, {
                                    timestamp: new Date().toISOString(),
                                    user: currentUser.name,
                                    action: '編輯員工',
                                    details: `${userPayload.id} - ${userPayload.name}`
                                }]
                            };
                        }

                        const updatedLeaves = prev.leaves.map(leave =>
                            leave.userId === targetId
                                ? { ...leave, userId: nextId, userName: userPayload.name, department: userPayload.department, region: userPayload.region }
                                : leave
                        );

                        const nextVacationSchedule = { ...prev.vacationSchedule };
                        if (nextVacationSchedule[targetId]) {
                            nextVacationSchedule[nextId] = nextVacationSchedule[targetId];
                            delete nextVacationSchedule[targetId];
                        }

                        const nextVacationNotes = { ...prev.vacationNotes };
                        if (nextVacationNotes[targetId]) {
                            nextVacationNotes[nextId] = nextVacationNotes[targetId];
                            delete nextVacationNotes[targetId];
                        }

                        return {
                            ...prev,
                            users: updatedUsers,
                            leaves: updatedLeaves,
                            vacationSchedule: nextVacationSchedule,
                            vacationNotes: nextVacationNotes,
                            auditLogs: [...prev.auditLogs, {
                                timestamp: new Date().toISOString(),
                                user: currentUser.name,
                                action: '編輯員工',
                                details: `${targetId} → ${nextId} - ${userPayload.name}`
                            }]
                        };
                    });

                    if (currentUser.id === targetId) {
                        setCurrentUser(prev => prev ? { ...prev, ...userPayload, id: nextId } : prev);
                    }
                    
                    alert('員工資料更新成功!');
                } else {
                    // 新增模式
                    // 檢查員工代號是否已存在
                    if (data.users.find(u => u.id === userPayload.id)) {
                        alert('員工代號已存在,請使用其他代號!');
                        return;
                    }

                    // 檢查帳號是否已存在
                    if (userPayload.username && data.users.find(u => u.username === userPayload.username)) {
                        alert('帳號已存在,請使用其他帳號!');
                        return;
                    }

                    if (data.users.find(u => u.email === newUserForm.email)) {
                        alert('Email 已存在,請使用其他 Email!');
                        return;
                    }

                    const newUser = {
                        ...userPayload,
                        usedAnnualLeave: 0
                    };

                    setData(prev => ({
                         ...prev,
                         users: [...prev.users, newUser],
                        auditLogs: [...prev.auditLogs, {
                            timestamp: new Date().toISOString(),
                            user: currentUser.name,
                            action: '新增員工',
                            details: `${newUser.id} - ${newUser.name}`
                        }]
                    }));
                    alert('員工新增成功!');
                }

                setNewUserForm({
                    id: '',
                    username: '',
                    name: '',
                    region: regionOptions[0],
                    department: departmentOptions[0],
                    position: '專員',
                    email: '',
                    phone: '',
                    birthday: '',
                    shift: [],
                    annualLeave: 10,
                    isAdmin: false,
                    permissionRegions: [...regionOptions],
                    permissionDepartments: [...departmentOptions]
                });

                setShowAddUser(false);
                setEditingUser(null);
            };

            const toggleShift = (shiftType) => {
                setNewUserForm(prev => ({
                    ...prev,
                    shift: prev.shift.includes(shiftType)
                        ? prev.shift.filter(s => s !== shiftType)
                        : [...prev.shift, shiftType]
                }));
            };

            const togglePermission = (type, value) => {
                setNewUserForm(prev => {
                    const key = type === 'region' ? 'permissionRegions' : 'permissionDepartments';
                    const current = prev[key] || [];
                    const next = current.includes(value)
                        ? current.filter(item => item !== value)
                        : [...current, value];
                    return { ...prev, [key]: next };
                });
            };

            const getEffectivePermissions = (permissions) =>
                Array.isArray(permissions) ? permissions : [];

            const canManageUser = (targetUser) => {
                if (!currentUser?.isAdmin) return false;
                const regionPermissions = getEffectivePermissions(currentUser.permissionRegions);
                const departmentPermissions = getEffectivePermissions(currentUser.permissionDepartments);
                return regionPermissions.includes(targetUser.region) || departmentPermissions.includes(targetUser.department);
            };

            const canApproveLeave = (leave) => {
                if (!currentUser?.isAdmin) return false;
                const regionPermissions = getEffectivePermissions(currentUser.permissionRegions);
                const departmentPermissions = getEffectivePermissions(currentUser.permissionDepartments);
                return regionPermissions.includes(leave.region) || departmentPermissions.includes(leave.department);
            };

            const pendingLeaves = data.leaves.filter(l => l.status === '待審核');
            const approvablePendingLeaves = pendingLeaves.filter(leave => canApproveLeave(leave));

             const formatLocalDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const parseDateString = (dateStr) => {
                if (!dateStr) return null;
                const [year, month, day] = dateStr.split('-').map(Number);
                if (!year || !month || !day) return null;
                return new Date(year, month - 1, day);
            };
            
            const getCompStats = (userId, monthDate) => {
                const targetMonth = monthDate.getMonth();
                const targetYear = monthDate.getFullYear();
                const compHours = data.leaves.filter(l =>
                    l.userId === userId &&
                    l.type === '補休(時)' &&
                    l.status === '已核准' &&
                    parseDateString(l.startDate)?.getMonth() === targetMonth &&
                    parseDateString(l.startDate)?.getFullYear() === targetYear
                );
                const compDays = data.leaves.filter(l =>
                    l.userId === userId &&
                    l.type === '補休(天)' &&
                    l.status === '已核准' &&
                    parseDateString(l.startDate)?.getMonth() === targetMonth &&
                    parseDateString(l.startDate)?.getFullYear() === targetYear
                );

                return {
                    hours: compHours.reduce((sum, l) => sum + (l.hours || 0), 0),
                    days: compDays.length
                };
            };

            const openScheduleModal = (dateStr) => {
                setSelectedScheduleDate(dateStr);
                setScheduleForm({ title: '', content: '' });
                setShowScheduleModal(true);
            };

            const handleScheduleSubmit = (e) => {
                e.preventDefault();
                if (!scheduleForm.title.trim() || !scheduleForm.content.trim()) {
                    alert('請填寫排程標題與內容');
                    return;
                }

                setData(prev => ({
                    ...prev,
                    schedules: [
                        ...(prev.schedules || []),
                        {
                            id: Date.now().toString(),
                            date: selectedScheduleDate,
                            title: scheduleForm.title.trim(),
                            content: scheduleForm.content.trim()
                        }
                    ]
                }));

                setShowScheduleModal(false);
            };

            const handleDeleteSchedule = (scheduleId) => {
                if (!window.confirm('確定要刪除此行程嗎？')) return;

                setData(prev => ({
                    ...prev,
                    schedules: (prev.schedules || []).filter(schedule => schedule.id !== scheduleId)
                }));
            };

            const handleSubmitLeave = (e) => {
                e.preventDefault();
                const newLeave = {
                    id: Date.now().toString(),
                    userId: currentUser.id,
                    userName: currentUser.name,
                    department: currentUser.department,
                    region: currentUser.region,
                    ...newLeaveForm,
                    status: '待審核',
                    submittedAt: new Date().toISOString()
                };

                setData(prev => ({
                    ...prev,
                    leaves: [...prev.leaves, newLeave]
                }));

                setNewLeaveForm({
                    type: '特休',
                    startDate: '',
                    endDate: '',
                    reason: '',
                    hours: 8
                });

                alert('請假申請已送出');
            };

            const handleApproveLeave = (leaveId, status) => {
                const targetLeave = data.leaves.find(l => l.id === leaveId);
                if (!targetLeave || !canApproveLeave(targetLeave)) {
                    alert('無權限審核此請假申請');
                    return;
                }
                setData(prev => ({
                    ...prev,
                    leaves: prev.leaves.map(l =>
                        l.id === leaveId ? { ...l, status } : l
                    )
                }));
            };

            const exportToCSV = (type) => {
                let csv = '';
                let filename = '';
 
                if (type === 'users') {
                    csv = '員工代號,姓名,地區,部門,職稱,Email,電話,生日,班別,總特休,已使用特休,剩餘特休\n';
                    data.users.forEach(u => {
                        const usedLeave = data.leaves.filter(l => l.userId === u.id && l.type === '特休' && l.status === '已核准').length;
                        csv += `${u.id},${u.name},${u.region},${u.department},${u.position},${u.email},${u.phone},${u.birthday},${u.shift.join('/')},${u.annualLeave},${usedLeave},${u.annualLeave - usedLeave}\n`;
                    });
                    filename = '人員管理.csv';
                } else if (type === 'vacation') {
                    csv = '員工代號,姓名,地區,部門,班別,';
                    const days = getMonthDays(selectedMonth);
                    days.forEach(day => {
                        csv += `${day.getMonth()+1}/${day.getDate()},`;
                    });
                    csv += '總請假天數\n';

                    data.users.forEach(user => {
                        const userLeaves = data.leaves.filter(l => l.userId === user.id && l.status === '已核准');
                        csv += `${user.id},${user.name},${user.region},${user.department},${user.shift.join('/')},`;
                        days.forEach(day => {
                            const dateStr = formatLocalDate(day);
                            const leave = userLeaves.find(l => dateStr >= l.startDate && dateStr <= l.endDate);
                            csv += `${leave ? leave.type : ''},`;
                        });
                        csv += `${userLeaves.filter(l => parseDateString(l.startDate)?.getMonth() === selectedMonth.getMonth()).length}\n`;
                    });
                    filename = `休假表_${selectedMonth.getFullYear()}年${selectedMonth.getMonth()+1}月.csv`;
                } else if (type === 'compensatory') {
                    csv = '員工代號,姓名,地區,部門,補休(時)已使用,補休(天)已使用\n';
                    data.users.forEach(u => {
                        const compHours = data.leaves.filter(l => l.userId === u.id && l.type === '補休(時)' && l.status === '已核准');
                        const compDays = data.leaves.filter(l => l.userId === u.id && l.type === '補休(天)' && l.status === '已核准');
                        const totalHours = compHours.reduce((sum, l) => sum + (l.hours || 0), 0);
                        csv += `${u.id},${u.name},${u.region},${u.department},${totalHours},${compDays.length}\n`;
                    });
                    filename = '補休表.csv';
                } else if (type === 'schedule') {
                    csv = '日期,標題,內容\n';
                    if (data.schedules && data.schedules.length > 0) {
                        data.schedules.forEach(s => {
                            csv += `${s.date},${s.title || ''},${s.content || ''}\n`;
                        });
                    } else {
                        csv += '目前沒有排程資料\n';
                    }
                    filename = '排程表.csv';
                } else if (type === 'leaves') {
                    csv = '申請日期,員工代號,姓名,地區,部門,假別,開始日期,結束日期,時數,事由,狀態,審核人,審核時間\n';
                    data.leaves.forEach(l => {
                        const user = data.users.find(u => u.id === l.userId);
                        csv += `${new Date(l.submittedAt).toLocaleDateString('zh-TW')},${user?.id || ''},${l.userName},${l.region},${l.department},${l.type},${l.startDate},${l.endDate},${l.hours},${l.reason},${l.status},${l.approvedBy || ''},${l.approvedAt ? new Date(l.approvedAt).toLocaleDateString('zh-TW') : ''}\n`;
                    });
                    filename = '請假紀錄.csv';
                } else if (type === 'annual') {
                    csv = '員工代號,姓名,地區,部門,職稱,總特休天數,已使用天數,剩餘天數,使用日期明細\n';
                    data.users.forEach(u => {
                        const annualLeaves = data.leaves.filter(l => l.userId === u.id && l.type === '特休' && l.status === '已核准');
                        const usedDays = annualLeaves.length;
                        const dates = annualLeaves.map(l => `${l.startDate}~${l.endDate}`).join('; ');
                        csv += `${u.id},${u.name},${u.region},${u.department},${u.position},${u.annualLeave},${usedDays},${u.annualLeave - usedDays},"${dates}"\n`;
                    });
                    filename = '特休總覽.csv';
                }

                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            };

            const getMonthDays = (date) => {
                const days = [];
                const year = date.getFullYear();
                const month = date.getMonth();
                const lastDay = new Date(year, month + 1, 0).getDate();

                for (let d = 1; d <= lastDay; d++) {
                    days.push(new Date(year, month, d));
                }
                return days;
            };

            const isHoliday = (date) => {
                const dateStr = formatLocalDate(date);
                return holidays2026.find(h => h.date === dateStr);
            };

            const isWeekend = (date) => {
                return date.getDay() === 0 || date.getDay() === 6;
            };

             const isWithinOpenRange = (date) => {
                const dateStr = formatLocalDate(date);
                const { openStart, openEnd } = data.vacationSettings;
                if (!openStart || !openEnd) return false;
                return dateStr >= openStart && dateStr <= openEnd;
            };

             const getDateRangeList = (startDate, endDate) => {
                if (!startDate || !endDate) return [];
                const cursor = new Date(startDate);
                const last = new Date(endDate);
                const dates = [];

                if (Number.isNaN(cursor.getTime()) || Number.isNaN(last.getTime())) return [];

                while (cursor <= last) {
                    dates.push(formatLocalDate(cursor));
                    cursor.setDate(cursor.getDate() + 1);
                }

                return dates;
            };

            const handleVacationSettingChange = (field, value) => {
                setData(prev => ({
                    ...prev,
                    vacationSettings: {
                        ...prev.vacationSettings,
                        [field]: value
                    }
                }));
            };

             const vacationMarkerOptions = [
                { value: '▲-black', label: '▲ 黑色', symbol: '▲', textClass: 'text-gray-900', activeClass: 'border-gray-800 bg-gray-100' },
                { value: '▲-red', label: '▲ 紅色', symbol: '▲', textClass: 'text-red-600', activeClass: 'border-red-500 bg-red-50' },
                { value: '★-black', label: '★ 黑色', symbol: '★', textClass: 'text-gray-900', activeClass: 'border-gray-800 bg-gray-100' },
                { value: '★-red', label: '★ 紅色', symbol: '★', textClass: 'text-red-600', activeClass: 'border-red-500 bg-red-50' }
            ];

            const getMarkerDisplay = (marker) => {
                if (!marker) return null;
                if (marker.includes('-')) {
                    const [symbol, color] = marker.split('-');
                    return {
                        symbol,
                        className: color === 'red' ? 'text-red-600 font-bold' : 'text-gray-900 font-bold'
                    };
                }
                if (marker === '★') {
                    return { symbol: '★', className: 'text-red-600 font-bold' };
                }
                return { symbol: marker, className: 'text-gray-900 font-bold' };
            };

            const handleToggleVacation = (userId, dateStr) => {
                if (!data.vacationSettings.openStart || !data.vacationSettings.openEnd) return;
                const isOpen = dateStr >= data.vacationSettings.openStart && dateStr <= data.vacationSettings.openEnd;
                if (!isOpen) return;
                if (!currentUser.isAdmin && currentUser.id !== userId) return;
                setData(prev => {
                    const userSchedule = prev.vacationSchedule[userId] || {};
                    const currentMarker = userSchedule[dateStr];
                    const nextMarker = currentMarker === selectedVacationMarker ? '' : selectedVacationMarker;
                    return {
                        ...prev,
                        vacationSchedule: {
                            ...prev.vacationSchedule,
                            [userId]: {
                                ...userSchedule,
                                [dateStr]: nextMarker
                            }
                        }
                    };
                });
            };

            const getWorkingCount = (date) => {
                const dateStr = formatLocalDate(date);
                const onLeaveUserIds = new Set(
                    data.leaves
                        .filter(l => l.status === '已核准' && dateStr >= l.startDate && dateStr <= l.endDate)
                        .map(l => l.userId)
                );
                const vacationUserIds = new Set(
                    Object.entries(data.vacationSchedule)
                        .filter(([, userSchedule]) => Boolean(userSchedule?.[dateStr]))
                        .map(([userId]) => userId)
                );
                return data.users.filter(user => !onLeaveUserIds.has(user.id) && !vacationUserIds.has(user.id)).length;
            };

            const getWorkingUsersByDate = (dateStr) => {
                const onLeaveUserIds = new Set(
                    data.leaves
                        .filter(l => l.status === '已核准' && dateStr >= l.startDate && dateStr <= l.endDate)
                        .map(l => l.userId)
                );
                const vacationUserIds = new Set(
                    Object.entries(data.vacationSchedule)
                        .filter(([, userSchedule]) => Boolean(userSchedule?.[dateStr]))
                        .map(([userId]) => userId)
                );
                return data.users.filter(user => !onLeaveUserIds.has(user.id) && !vacationUserIds.has(user.id));
            };

            const currentViewDateStr = formatLocalDate(workingViewDate);
            const todayWorkingUsers = getWorkingUsersByDate(currentViewDateStr);
            const todayWorkingByDepartment = todayWorkingUsers.reduce((acc, user) => {
                if (!acc[user.department]) acc[user.department] = [];
                acc[user.department].push(user);
                return acc;
            }, {});
            
             const getCompensatoryCellData = (userId, dateStr) => {
                const matchedLeaves = data.leaves.filter(l =>
                    l.userId === userId &&
                    l.status === '已核准' &&
                    (l.type === '補休(時)' || l.type === '補休(天)') &&
                    dateStr >= l.startDate &&
                    dateStr <= l.endDate
                );

                if (matchedLeaves.length === 0) return null;

                const hasDayComp = matchedLeaves.some(l => l.type === '補休(天)');
                const totalHourComp = matchedLeaves
                    .filter(l => l.type === '補休(時)')
                    .reduce((sum, leave) => sum + Number(leave.hours || 0), 0);

                if (hasDayComp && totalHourComp > 0) {
                    return `天/${totalHourComp}h`;
                }

                if (hasDayComp) return '補休天';
                return `${totalHourComp}h`;
            };

            const handleResetData = () => {
                if (window.confirm('確定要重置所有資料嗎?這將清除所有員工和請假紀錄!')) {
                    localStorage.removeItem('leaveSystemData');
                    window.location.reload();
                }
            };

            
            return (
                <div className="min-h-screen bg-gray-50 text-base md:text-lg">
                    <div className="fixed top-0 left-0 right-0 z-30 bg-white">
                    <nav className="bg-white shadow-sm border-b">
                     <div className="max-w-screen-2xl mx-auto px-4 py-4">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center space-x-3">
                                    <div className="bg-indigo-600 w-10 h-10 rounded-lg flex items-center justify-center">
                                        <Users size={24} className="text-white" />
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-bold">員工假勤系統</h1>
                                       <p className="text-sm md:text-base text-gray-500">歡迎, {currentUser.name}</p>
                                    </div>
                                </div>

                                <div className="flex items-center space-x-4">
                                    <div className="text-right">
                                        <p className="text-sm md:text-base text-gray-600">可休特休</p>
                                        <p className="text-lg font-bold text-indigo-600">
                                            {currentUser.annualLeave} 天
                                        </p>
                                    </div>
                                    <button onClick={handleLogout} className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                                        回到預設使用者
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <div className="bg-white border-b">
                        <div className="max-w-screen-2xl mx-auto px-4">
                            <div className="flex space-x-1">
                                {[
                                    { id: 'management', label: '人員管理', icon: Users, admin: true },
                                    { id: 'todayWorking', label: '當日上班人員', icon: Bell },
                                    { id: 'vacation', label: '休假表', icon: Calendar },
                                    { id: 'compensatory', label: '補休表', icon: Clock },
                                    { id: 'schedule', label: '排程表', icon: Clipboard },
                                    { id: 'leave', label: '請假', icon: FileText },
                                    { id: 'annual', label: '特休', icon: Calendar }
                                ].map(tab => {
                                    if (tab.admin && !currentUser.isAdmin) return null;
                                    const Icon = tab.icon;
                                    return (
                                        <button
                                            key={tab.id}
                                            onClick={() => setActiveTab(tab.id)}
                                            className={`flex items-center space-x-2 px-6 py-3 border-b-2 ${
                                                activeTab === tab.id ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-600'
                                            }`}
                                        >
                                            <Icon size={18} />
                                            <span>{tab.label}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                   </div>

                    <div className="max-w-screen-2xl mx-auto px-4 py-6 pt-40">
                        {activeTab === 'todayWorking' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">當日上班人員</h2>
                                   <div className="flex items-center gap-2">
                                        <button
                                            onClick={() => setWorkingViewDate(prev => new Date(prev.getFullYear(), prev.getMonth(), prev.getDate() - 1))}
                                            className="px-3 py-1 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50"
                                        >
                                            上一頁(昨天)
                                        </button>
                                        <span className="text-base text-gray-500">日期：{currentViewDateStr}</span>
                                        <button
                                            onClick={() => setWorkingViewDate(prev => new Date(prev.getFullYear(), prev.getMonth(), prev.getDate() + 1))}
                                            className="px-3 py-1 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50"
                                        >
                                            下一頁(明天)
                                        </button>
                                    </div>
                                </div>
                                <div className="bg-white rounded-lg shadow p-4">
                                    <p className="text-lg font-medium text-indigo-700 mb-3">今日上班總人數：{todayWorkingUsers.length} 人</p>
                                    {todayWorkingUsers.length === 0 ? (
                                        <p className="text-gray-500">今日無上班人員。</p>
                                    ) : (
                                        <div className="space-y-4">
                                            {Object.entries(todayWorkingByDepartment).map(([department, users]) => (
                                                <div key={department} className="border border-gray-100 rounded-lg p-3">
                                                    <h3 className="text-lg font-semibold text-gray-800 mb-2">{department}</h3>
                                                    <div className="flex flex-wrap gap-2">
                                                        {users.map(user => (
                                                            <span key={user.id} className="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-sm md:text-base">
                                                                {user.name}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'management' && currentUser.isAdmin && (
                            <div className="space-y-4">
                                <div className="flex justify-between">
                                    <h2 className="text-2xl font-bold">人員管理</h2>
                                    <div className="flex space-x-2">
                                       <button
                                            onClick={() => setShowAddUser(!showAddUser)}
                                            className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                        >
                                            {showAddUser ? '取消新增' : '+ 新增員工'}
                                        </button>
                                        <button onClick={() => exportToCSV('users')} className="px-4 py-2 bg-green-600 text-white rounded-lg">
                                            匯出Excel
                                        </button>
                                    </div>
                                </div>

                                {showAddUser && (
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">{editingUser ? '編輯員工' : '新增員工'}</h3>
                                        <form onSubmit={handleAddUser} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">員工代號 *</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.id}
                                                    onChange={(e) => setNewUserForm({...newUserForm, id: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                    placeholder="例如: E003"
                                                    required
                                                />
                                                <p className="text-xs text-gray-500 mt-1">請輸入唯一的員工代號</p>
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">帳號</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.username}
                                                    onChange={(e) => setNewUserForm({...newUserForm, username: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                    placeholder="登入用帳號（可留空）"
                                                />
                                            </div>

                                            <div>
                                               <label className="block text-sm md:text-base font-medium mb-1">姓名 *</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.name}
                                                    onChange={(e) => setNewUserForm({...newUserForm, name: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                    required
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">地區</label>
                                                <select
                                                    value={newUserForm.region}
                                                    onChange={(e) => setNewUserForm({...newUserForm, region: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                >
                                                    {regionOptions.map(region => (
                                                        <option key={region}>{region}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">部門</label>
                                                <select
                                                    value={newUserForm.department}
                                                    onChange={(e) => setNewUserForm({...newUserForm, department: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                >
                                                     {departmentOptions.map(department => (
                                                        <option key={department}>{department}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">職稱</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.position}
                                                    onChange={(e) => setNewUserForm({...newUserForm, position: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">Email</label>
                                                <input
                                                    type="email"
                                                    value={newUserForm.email}
                                                    onChange={(e) => setNewUserForm({...newUserForm, email: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">電話</label>
                                                <input
                                                    type="tel"
                                                    value={newUserForm.phone}
                                                    onChange={(e) => setNewUserForm({...newUserForm, phone: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                    placeholder="0912-345-678"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">生日 (月/日)</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.birthday}
                                                    onChange={(e) => setNewUserForm({...newUserForm, birthday: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                    placeholder="例如: 05/15 "
                                                />
                                                <p className="text-xs text-gray-500 mt-1">格式: 月/日 (不需要輸入年份)</p>
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">班別</label>
                                                <div className="flex space-x-4 mt-2">
                                                    <label className="flex items-center space-x-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={newUserForm.shift.includes('早')}
                                                            onChange={() => toggleShift('早')}
                                                            className="w-4 h-4"
                                                        />
                                                        <span>早班</span>
                                                    </label>
                                                    <label className="flex items-center space-x-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={newUserForm.shift.includes('晚')}
                                                            onChange={() => toggleShift('晚')}
                                                            className="w-4 h-4"
                                                        />
                                                        <span>晚班</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">年度特休天數</label>
                                                <input
                                                    type="number"
                                                    value={newUserForm.annualLeave}
                                                    onChange={(e) => setNewUserForm({...newUserForm, annualLeave: parseInt(e.target.value) || 0})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                    min="0"
                                                    max="30"
                                                />
                                            </div>

                                            <div className="md:col-span-2">
                                                <label className="flex items-center space-x-2">
                                                    <input
                                                        type="checkbox"
                                                        checked={newUserForm.isAdmin}
                                                        onChange={(e) => setNewUserForm({...newUserForm, isAdmin: e.target.checked})}
                                                        className="w-4 h-4"
                                                    />
                                                     <span className="text-sm md:text-base font-medium">設為管理員</span>
                                                    <span className="text-xs text-gray-500">(管理員可以管理所有員工和審核請假)</span>
                                                </label>
                                            </div>

                                           {newUserForm.isAdmin && (
                                                <div className="md:col-span-2 rounded-lg border border-indigo-100 bg-indigo-50 p-4">
                                                    <div className="flex items-center justify-between">
                                                        <h4 className="text-sm md:text-base font-semibold text-indigo-700">權限管理</h4>
                                                        <span className="text-xs text-gray-500">僅勾選的地區/部門可審核或編輯員工資料</span>
                                                    </div>
                                                     <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        <div>
                                                            <p className="text-sm md:text-base font-medium text-gray-700 mb-2">地區</p>
                                                            <div className="space-y-2">
                                                                {regionOptions.map(region => (
                                                                    <label key={region} className="flex items-center space-x-2 text-sm md:text-base">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={newUserForm.permissionRegions.includes(region)}
                                                                            onChange={() => togglePermission('region', region)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>{region}</span>
                                                                    </label>
                                                                ))}
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <p className="text-sm md:text-base font-medium text-gray-700 mb-2">部門</p>
                                                            <div className="space-y-2">
                                                                {departmentOptions.map(department => (
                                                                    <label key={department} className="flex items-center space-x-2 text-sm md:text-base">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={newUserForm.permissionDepartments.includes(department)}
                                                                            onChange={() => togglePermission('department', department)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>{department}</span>
                                                                    </label>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                           )}

                                            <div className="md:col-span-2 flex space-x-2">
                                               <button
                                                    type="submit"
                                                    className="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700"
                                                >
                                                    {editingUser ? '更新員工' : '確認新增'}
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => {
                                                        setShowAddUser(false);
                                                        setEditingUser(null);
                                                        setNewUserForm({
                    id: '',
                    username: '',
                                                            name: '',
                                                            region: regionOptions[0],
                                                            department: departmentOptions[0],
                                                            position: '專員',
                                                            email: '',
                                                            phone: '',
                                                            birthday: '',
                                                            shift: [],
                                                            annualLeave: 10,
                                                            isAdmin: false,
                                                            permissionRegions: [...regionOptions],
                                                            permissionDepartments: [...departmentOptions]
                                                        });
                                                    }}
                                                    className="px-6 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300"
                                                >
                                                    取消
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                )}

                                <div className="bg-white rounded-lg shadow overflow-x-auto">
                                    <table className="w-full">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-4 py-3 text-left text-xs">員工代號</th>
                                                <th className="px-4 py-3 text-left text-xs">姓名</th>
                                                <th className="px-4 py-3 text-left text-xs">地區</th>
                                                <th className="px-4 py-3 text-left text-xs">部門</th>
                                                <th className="px-4 py-3 text-left text-xs">職稱</th>
                                                <th className="px-4 py-3 text-left text-xs">Email</th>
                                                <th className="px-4 py-3 text-left text-xs">電話</th>
                                                <th className="px-4 py-3 text-left text-xs">班別</th>
                                                <th className="px-4 py-3 text-left text-xs">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.users.map(user => {
                                                const canManage = canManageUser(user);
                                                return (
                                                    <tr key={user.id}>
                                                        <td className="px-4 py-3">{user.id}</td>
                                                        <td className="px-4 py-3">{user.name}</td>
                                                        <td className="px-4 py-3">{user.region}</td>
                                                        <td className="px-4 py-3">{user.department}</td>
                                                        <td className="px-4 py-3">{user.position}</td>
                                                        <td className="px-4 py-3">{user.email}</td>
                                                        <td className="px-4 py-3">{user.phone}</td>
                                                        <td className="px-4 py-3">
                                                            <div className="flex space-x-1">
                                                                {user.shift.includes('早') && (
                                                                    <span className="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">早</span>
                                                                )}
                                                                {user.shift.includes('晚') && (
                                                                    <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">晚</span>
                                                                )}
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <div className="flex space-x-2">
                                                                <button
                                                                    onClick={() => canManage && handleEditUser(user)}
                                                                    className={`text-blue-600 ${canManage ? 'hover:text-blue-800' : 'opacity-40 cursor-not-allowed'}`}
                                                                    title={canManage ? '編輯' : '無權限編輯此員工'}
                                                                    disabled={!canManage}
                                                                >
                                                                    <Edit2 size={16} />
                                                                </button>
                                                                <button
                                                                    onClick={() => canManage && handleDeleteUser(user.id)}
                                                                    className={`text-red-600 ${canManage ? 'hover:text-red-800' : 'opacity-40 cursor-not-allowed'}`}
                                                                    title={canManage ? '刪除' : '無權限刪除此員工'}
                                                                    disabled={!canManage}
                                                                >
                                                                    <Trash2 size={16} />
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>

                                <div className="bg-white rounded-lg shadow p-4">
                                    <h3 className="text-lg font-bold mb-4">操作紀錄</h3>
                                    <div className="space-y-2 max-h-64 overflow-y-auto">
                                        {data.auditLogs.slice(-10).reverse().map((log, idx) => (
                                            <div key={idx} className="text-sm md:text-base p-2 bg-gray-50 rounded">
                                                <span className="text-gray-500">{new Date(log.timestamp).toLocaleString('zh-TW')}</span>
                                                {' - '}
                                                <span className="font-medium">{log.user}</span>
                                                {' '}
                                                <span className="text-indigo-600">{log.action}</span>
                                                {' - '}
                                                <span>{log.details}</span>
                                            </div>
                                        ))}
                                        {data.auditLogs.length === 0 && (
                                            <p className="text-center text-gray-500 py-4">目前沒有操作紀錄</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'vacation' && (
                            <div className="space-y-4">
                                {/* 可休天數顯示 */}
                                  <div className="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-lg p-4 text-white">
                                    <div>
                                        <h3 className="text-base opacity-90">我的可休天數</h3>
                                        <p className="text-3xl font-bold mt-1">{currentUser.annualLeave - (data.leaves.filter(l => l.userId === currentUser.id && l.type === '特休' && l.status === '已核准').length)} 天</p>
                                        <p className="text-xs opacity-80 mt-1">已使用: {data.leaves.filter(l => l.userId === currentUser.id && l.type === '特休' && l.status === '已核准').length} 天</p>
                                    </div>
                                </div>

                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">休假表</h2>
                                    <div className="flex space-x-2">
                                        <select
                                            value={filterRegion}
                                            onChange={(e) => setFilterRegion(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>地區</option>
                                            <option>新竹區</option>
                                            <option>台中區</option>
                                            <option>嘉義區</option>
                                        </select>
                                        <select
                                            value={filterDepartment}
                                            onChange={(e) => setFilterDepartment(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>部門</option>
                                            <option>管理部</option>
                                            <option>TSE</option>
                                            <option>FAE</option>
                                            <option>新場</option>
                                            <option>倉管</option>
                                            <option>RD</option>
                                            <option>線上客服</option>
                                        </select>
                                        <select
                                            value={filterShift}
                                            onChange={(e) => setFilterShift(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>班別</option>
                                            <option>早</option>
                                            <option>晚</option>
                                        </select>
                                        <button
                                            onClick={() => exportToCSV('vacation')}
                                            className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                        >
                                            <Download size={18} />
                                            <span>匯出Excel</span>
                                        </button>
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow p-4">
                                             {currentUser.isAdmin && (
                                        <div className="mb-4 rounded-lg border border-indigo-100 bg-indigo-50 p-3">
                                            <p className="text-sm md:text-base font-medium text-indigo-700 mb-2">班表開放日期設定 (管理員)</p>
                                            <div className="flex flex-wrap gap-3 items-center">
                                                <div className="flex items-center space-x-2">
                                                   <label className="text-sm md:text-base text-gray-700">開始</label>
                                                    <input
                                                        type="date"
                                                        value={data.vacationSettings.openStart}
                                                        onChange={(e) => handleVacationSettingChange('openStart', e.target.value)}
                                                        className="px-3 py-2 border rounded-lg"
                                                    />
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                     <label className="text-sm md:text-base text-gray-700">結束</label>
                                                    <input
                                                        type="date"
                                                        value={data.vacationSettings.openEnd}
                                                        onChange={(e) => handleVacationSettingChange('openEnd', e.target.value)}
                                                        className="px-3 py-2 border rounded-lg"
                                                    />
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                    <label className="text-sm md:text-base text-gray-700">本月可休天數</label>
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        value={data.vacationSettings.monthlyVacationDays}
                                                        onChange={(e) => handleVacationSettingChange('monthlyVacationDays', e.target.value)}
                                                        className="w-24 px-3 py-2 border rounded-lg"
                                                    />
                                                    <span className="text-sm md:text-base text-gray-600">天</span>
                                                </div>
                                                <span className="text-xs text-gray-600">
                                                    開放期間內員工可自行編輯休假日
                                                </span>
                                            </div>
                                        </div>
                                    )}
                                    <div className="mb-4 flex flex-wrap items-center gap-3 text-sm md:text-base text-gray-600">
                                        <div className="flex flex-wrap items-center gap-2">
                                            <span className="font-medium text-gray-700">休假符號:</span>
                                           {vacationMarkerOptions.map(option => (
                                                <button
                                                    key={option.value}
                                                    onClick={() => setSelectedVacationMarker(option.value)}
                                                    className={`px-2 py-1 rounded border ${selectedVacationMarker === option.value ? option.activeClass : 'border-gray-200'}`}
                                                >
                                                    <span className={`${option.textClass} font-bold`}>{option.symbol}</span> {option.label.split(' ')[1]}
                                                </button>
                                            ))}
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            {data.vacationSettings.openStart && data.vacationSettings.openEnd
                                                ? `開放期間: ${data.vacationSettings.openStart} ~ ${data.vacationSettings.openEnd}`
                                                : '尚未設定開放日期'}
                                        </div>
                                          <div className="text-sm md:text-base text-gray-600">
                                            本月可休: {data.vacationSettings.monthlyVacationDays || '未設定'} 天
                                        </div>
                                    </div>
                                    <div className="flex justify-between mb-4">
                                        <button onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1))} className="px-4 py-2 bg-gray-100 rounded">
                                            上個月
                                        </button>
                                        <h3 className="text-xl font-bold">
                                            {selectedMonth.getFullYear()}年 {selectedMonth.getMonth() + 1}月
                                        </h3>
                                        <button onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1))} className="px-4 py-2 bg-gray-100 rounded">
                                            下個月
                                        </button>
                                    </div>

                                    <div>
                                        <table className="w-full border-collapse text-sm md:text-base table-fixed">
                                            <thead>
                                                <tr>
                                                   <th className="border-2 border-gray-400 p-2 bg-gray-100 sticky left-0 z-20 w-28 text-sm md:text-base">星期</th>
                                                    {getMonthDays(selectedMonth).map(day => {
                                                        const holiday = isHoliday(day);
                                                        const weekend = isWeekend(day);
                                                        const dayName = ['日','一','二','三','四','五','六'][day.getDay()];
                                                        return (
                                                            <th
                                                                key={`week-${day.toISOString()}`}
                                                                className={`border-2 p-1 text-center text-sm md:text-base font-bold ${
                                                                    holiday ? 'bg-red-200 text-red-900 border-red-400' :
                                                                    weekend ? 'bg-blue-200 text-blue-900 border-blue-400' :
                                                                    'bg-gray-50 border-gray-300'
                                                                }`}
                                                            >
                                                                {dayName}
                                                            </th>
                                                        );
                                                    })}
                                                  <th className="border-2 border-gray-400 p-2 bg-yellow-100 font-bold sticky right-0 z-20 w-24 whitespace-nowrap text-sm md:text-base">已選天數</th>
                                                </tr>
                                                <tr>
                                                    <th className="border-2 border-gray-400 p-2 bg-gray-100 sticky left-0 z-20 text-sm md:text-base">日期</th>
                                                    {getMonthDays(selectedMonth).map(day => {
                                                        const holiday = isHoliday(day);
                                                        const weekend = isWeekend(day);
                                                        return (
                                                            <th
                                                                key={`date-${day.toISOString()}`}
                                                                 className={`border-2 p-1 text-center text-sm md:text-base font-bold ${
                                                                    holiday ? 'bg-red-200 text-red-900 border-red-400' :
                                                                    weekend ? 'bg-blue-200 text-blue-900 border-blue-400' :
                                                                    'bg-gray-50 border-gray-300'
                                                                }`}
                                                            >
                                                                {day.getDate()}
                                                            </th>
                                                        );
                                                    })}
                                                    <th className="border-2 border-gray-400 p-2 bg-yellow-100 sticky right-0 z-20"></th>
                                                </tr>
                                                <tr>
                                                 <th className="border-2 border-gray-400 p-2 bg-gray-100 sticky left-0 z-20 text-sm md:text-base">國定假日</th>
                                                    {getMonthDays(selectedMonth).map(day => {
                                                        const holiday = isHoliday(day);
                                                        const weekend = isWeekend(day);
                                                        return (
                                                            <th
                                                                key={`note-${day.toISOString()}`}
                                                               className={`border-2 p-1 text-center text-sm md:text-base ${
                                                                    holiday ? 'bg-red-200 text-red-900 border-red-400' :
                                                                    weekend ? 'bg-blue-200 text-blue-900 border-blue-400' :
                                                                    'bg-gray-50 border-gray-300'
                                                                }`}
                                                            >
                                                                {holiday ? holiday.name : ''}
                                                            </th>
                                                        );
                                                    })}
                                                    <th className="border-2 border-gray-400 p-2 bg-yellow-100 sticky right-0 z-20"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {data.users
                                                    .filter(u =>
                                                        (filterRegion === '全部' || u.region === filterRegion) &&
                                                        (filterDepartment === '全部' || u.department === filterDepartment) &&
                                                        (filterShift === '全部' || u.shift.includes(filterShift))
                                                    )
                                                    .map(user => {
                                                       const userLeaves = data.leaves.filter(l =>
                                                            l.userId === user.id &&
                                                            l.status === '已核准' &&
                                                            parseDateString(l.startDate)?.getMonth() === selectedMonth.getMonth()
                                                        );
                                                        const isCurrentUser = user.id === currentUser.id;
                                                        const markerCount = (data.vacationSchedule[user.id] && Object.values(data.vacationSchedule[user.id]).filter(Boolean).length) || 0;

                                                        return (
                                                            <tr key={user.id} className={isCurrentUser ? 'bg-indigo-50' : ''}>
                                                                <td className="border-2 border-gray-400 p-2 font-medium bg-white sticky left-0 z-10">
                                                                    <div>
                                                                        {user.name}
                                                                        {isCurrentUser && <span className="ml-1 text-xs bg-indigo-600 text-white px-2 py-0.5 rounded">我</span>}
                                                                    </div>
                                                                    <div className="text-xs text-gray-500">{user.department}</div>
                                                                    <div className="flex gap-1 mt-1">
                                                                        {user.shift.includes('早') && (
                                                                            <span className="px-1 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded">早</span>
                                                                        )}
                                                                        {user.shift.includes('晚') && (
                                                                            <span className="px-1 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">晚</span>
                                                                        )}
                                                                    </div>
                                                                </td>
                                                                {getMonthDays(selectedMonth).map(day => {
                                                                    const dateStr = formatLocalDate(day);
                                                                    const leave = userLeaves.find(l =>
                                                                        dateStr >= l.startDate && dateStr <= l.endDate
                                                                    );
                                                                    const holiday = isHoliday(day);
                                                                    const weekend = isWeekend(day);
                                                                    const customMarker = data.vacationSchedule[user.id]?.[dateStr];
                                                                    const isOpen = isWithinOpenRange(day);
                                                                    const isEditable = isOpen && (currentUser.isAdmin || isCurrentUser);
                                                                    const markerDisplay = getMarkerDisplay(customMarker);

                                                                    return (
                                                                        <td
                                                                            key={day.toISOString()}
                                                                             className={`border p-1 text-center ${
                                                                                leave ? 'bg-orange-100 text-orange-900 font-bold border-orange-300' :
                                                                                holiday ? 'bg-red-50 border-red-200' :
                                                                                weekend ? 'bg-blue-50 border-blue-200' :
                                                                                     'border-gray-200'
                                                                            } ${isEditable ? 'cursor-pointer hover:bg-indigo-50' : ''}`}
                                                                            onClick={() => handleToggleVacation(user.id, dateStr)}
                                                                            title={isEditable ? '點擊設定休假標記' : ''}
                                                                        >
                                                                                                                      {leave ? (
                                                                                <span className="text-purple-700 font-semibold">請</span>
                                                                            ) : markerDisplay ? (
                                                                                <span className={markerDisplay.className}>
                                                                                    {markerDisplay.symbol}
                                                                                </span>
                                                                            ) : ''}
                                                                        </td>
                                                                    );
                                                                })}
                                                                <td className="border-2 border-gray-400 p-2 text-center font-bold text-base text-indigo-700 bg-yellow-50 sticky right-0 z-10 w-24 whitespace-nowrap">
                                                                    {markerCount}
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                <tr className="bg-green-50">
                                                    <td className="border-2 border-gray-400 p-2 font-bold text-center sticky left-0 z-10 bg-green-100">上班人數</td>
                                                    {getMonthDays(selectedMonth).map(day => {
                                                        return (
                                                            <td
                                                                key={`count-${day.toISOString()}`}
                                                                className="border-2 border-gray-300 p-2 text-center font-bold text-green-700 bg-green-50"
                                                            >
                                                                {getWorkingCount(day)}
                                                                </td>
                                                );
                                            })}
                                                    <td className="border-2 border-gray-400 p-2 sticky right-0 z-10 bg-green-100"></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
 
                                    <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                                         <h4 className="font-bold mb-2 text-sm md:text-base">圖例說明:</h4>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                                            <div className="flex items-center space-x-2">
                                                <div className="w-4 h-4 bg-red-200 border-2 border-red-400"></div>
                                                <span>國定假日</span>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <div className="w-4 h-4 bg-blue-200 border-2 border-blue-400"></div>
                                                <span>週末</span>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <div className="w-4 h-4 bg-orange-100 border-2 border-orange-300"></div>
                                                 <span>已核准請假</span>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <div className="w-4 h-4 bg-indigo-50 border-2"></div>
                                                <span>我的資料</span>
                                            </div>
                                        </div>
                                       <p className="text-xs text-gray-600 mt-2">💡 開放期間內可點擊自己的日期設定▲/★（黑或紅）</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'leave' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">請假申請</h2>
                                    <button
                                        onClick={() => exportToCSV('leaves')}
                                        className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        <Download size={18} />
                                        <span>匯出Excel</span>
                                    </button>
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">新增請假</h3>
                                        <form onSubmit={handleSubmitLeave} className="space-y-4">
                                            <input type="text" value={currentUser.name} disabled className="w-full px-3 py-2 border rounded bg-gray-50" />

                                            <select value={newLeaveForm.type} onChange={(e) => setNewLeaveForm({...newLeaveForm, type: e.target.value})} className="w-full px-3 py-2 border rounded">
                                                <option>特休</option>
                                                <option>病假</option>
                                                <option>事假</option>
                                                <option>旅遊假</option>
                                                <option>喪假</option>
                                                <option>生理假</option>
                                                <option>補休(時)</option>
                                                <option>補休(天)</option>
                                                <option>年假</option>
                                            </select>

                                            <input type="date" value={newLeaveForm.startDate} onChange={(e) => setNewLeaveForm({...newLeaveForm, startDate: e.target.value})} className="w-full px-3 py-2 border rounded" required />

                                            <input type="date" value={newLeaveForm.endDate} onChange={(e) => setNewLeaveForm({...newLeaveForm, endDate: e.target.value})} className="w-full px-3 py-2 border rounded" required />

                                            <textarea value={newLeaveForm.reason} onChange={(e) => setNewLeaveForm({...newLeaveForm, reason: e.target.value})} className="w-full px-3 py-2 border rounded" rows="3" required />

                                            <button type="submit" className="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">
                                                送出申請
                                            </button>
                                        </form>
                                    </div>

                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">我的申請</h3>
                                        <div className="space-y-3">
                                            {data.leaves.filter(l => l.userId === currentUser.id).map(leave => (
                                                <div key={leave.id} className="border rounded p-3">
                                                    <div className="flex justify-between mb-2">
                                                        <span className="font-medium">{leave.type}</span>
                                                        <span className={`px-2 py-1 text-xs rounded ${leave.status === '已核准' ? 'bg-green-100' : 'bg-yellow-100'}`}>
                                                            {leave.status}
                                                        </span>
                                                    </div>
                                                     <p className="text-sm md:text-base">{leave.startDate} ~ {leave.endDate}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {currentUser.isAdmin && (
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">待審核 (管理員)</h3>
                                          <p className="text-xs text-gray-500 mb-3">僅可審核具權限的地區或部門</p>
                                       {approvablePendingLeaves.map(leave => {
                                            return (
                                                <div key={leave.id} className="border rounded p-4 mb-3">
                                                    <div className="flex justify-between">
                                                        <div>
                                                            <p className="font-medium">{leave.userName} - {leave.type}</p>
                                                            <p className="text-sm md:text-base">{leave.startDate} ~ {leave.endDate}</p>
                                                            <p className="text-xs text-gray-500">{leave.region} / {leave.department}</p>
                                                        </div>
                                                        <div className="flex space-x-2">
                                                            <button
                                                               onClick={() => handleApproveLeave(leave.id, '已核准')}
                                                                className="px-3 py-1 rounded text-white bg-green-600"
                                                            >
                                                                核准
                                                            </button>
                                                            <button
                                                               onClick={() => handleApproveLeave(leave.id, '已拒絕')}
                                                                className="px-3 py-1 rounded text-white bg-red-600"
                                                            >
                                                                拒絕
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                             );
                                        })}
                                       {approvablePendingLeaves.length === 0 && (
                                            <p className="text-center text-gray-500 py-4">目前沒有待審核申請</p>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'annual' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">特休總覽</h2>
                                    <div className="flex space-x-2">
                                        <select
                                            value={filterRegion}
                                            onChange={(e) => setFilterRegion(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>全部</option>
                                            <option>新竹區</option>
                                            <option>台中區</option>
                                            <option>嘉義區</option>
                                        </select>
                                        <select
                                            value={filterDepartment}
                                            onChange={(e) => setFilterDepartment(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>全部</option>
                                            <option>管理部</option>
                                            <option>TSE</option>
                                            <option>FAE</option>
                                            <option>新場</option>
                                            <option>倉管</option>
                                            <option>RD</option>
                                            <option>線上客服</option>
                                        </select>
                                         <select
                                            value={filterShift}
                                            onChange={(e) => setFilterShift(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>全部</option>
                                            <option>早</option>
                                            <option>晚</option>
                                        </select>
                                        <button
                                            onClick={() => exportToCSV('annual')}
                                            className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                        >
                                            <Download size={18} />
                                            <span>匯出Excel</span>
                                        </button>
                                    </div>
                                </div>
                                <div className="bg-white rounded-lg shadow overflow-x-auto">
                                    <table className="w-full">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-4 py-3 text-left">員工</th>
                                                <th className="px-4 py-3 text-left">地區</th>
                                                <th className="px-4 py-3 text-left">部門</th>
                                                <th className="px-4 py-3 text-left">班別</th>
                                                <th className="px-4 py-3 text-left">總特休</th>
                                                <th className="px-4 py-3 text-left">已使用</th>
                                                <th className="px-4 py-3 text-left">剩餘</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.users.filter(user =>
                                                (filterRegion === '全部' || user.region === filterRegion) &&
                                                (filterDepartment === '全部' || user.department === filterDepartment) &&
                                                (filterShift === '全部' || user.shift.includes(filterShift))
                                            ).map(user => {
                                                const used = data.leaves.filter(l => l.userId === user.id && l.type === '特休' && l.status === '已核准').length;
                                                return (
                                                    <tr key={user.id}>
                                                         <td className="px-4 py-3">
                                                            <button
                                                                type="button"
                                                                onClick={() => setSelectedAnnualUserId(user.id)}
                                                                className="text-blue-600 hover:text-blue-800 hover:underline"
                                                            >
                                                                {user.name}
                                                            </button>
                                                        </td>
                                                        <td className="px-4 py-3">{user.region}</td>
                                                        <td className="px-4 py-3">{user.department}</td>
                                                        <td className="px-4 py-3">{user.shift.join('/')}</td>
                                                        <td className="px-4 py-3">{user.annualLeave} 天</td>
                                                        <td className="px-4 py-3">{used} 天</td>
                                                        <td className="px-4 py-3">
                                                            <span className="px-2 py-1 bg-green-100 rounded">{user.annualLeave - used} 天</span>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>

                                {selectedAnnualUserId && (() => {
                                    const selectedUser = data.users.find(user => user.id === selectedAnnualUserId);
                                    if (!selectedUser) return null;

                                    const approvedAnnualLeaves = data.leaves.filter(
                                        leave => leave.userId === selectedAnnualUserId && leave.type === '特休' && leave.status === '已核准'
                                    );
                                    const uniqueLeaveDates = [
                                        ...new Set(
                                            approvedAnnualLeaves.flatMap(leave => getDateRangeList(leave.startDate, leave.endDate))
                                        )
                                    ].sort();

                                    return (
                                        <div className="bg-white rounded-lg shadow p-6 space-y-3">
                                            <div className="flex items-center justify-between">
                                                <h3 className="text-lg font-bold">{selectedUser.name} 特休明細</h3>
                                                <button
                                                    type="button"
                                                    onClick={() => setSelectedAnnualUserId('')}
                                                    className="text-sm text-gray-500 hover:text-gray-700"
                                                >
                                                    關閉
                                                </button>
                                            </div>
                                            <p className="text-sm text-gray-600">核准特休筆數：{approvedAnnualLeaves.length} 筆</p>

                                            {approvedAnnualLeaves.length === 0 ? (
                                                <p className="text-gray-500">目前尚無已核准的特休紀錄。</p>
                                            ) : (
                                                <>
                                                    <div className="space-y-2">
                                                        {approvedAnnualLeaves.map(leave => (
                                                            <div key={leave.id} className="p-3 border rounded bg-gray-50 text-sm">
                                                                <div>{leave.startDate} ~ {leave.endDate}</div>
                                                                <div className="text-gray-600">事由：{leave.reason || '未填寫'}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <div>
                                                        <p className="text-sm font-medium mb-1">休假日期</p>
                                                        <div className="flex flex-wrap gap-2">
                                                            {uniqueLeaveDates.map(date => (
                                                                <span key={date} className="px-2 py-1 text-xs rounded bg-indigo-100 text-indigo-700">{date}</span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    );
                                })()}
                            </div>
                        )}

                        {/* 補休表 */}
                        {activeTab === 'compensatory' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">補休表</h2>
                                    <div className="flex space-x-2">
                                        <select
                                            value={filterRegion}
                                            onChange={(e) => setFilterRegion(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>全部</option>
                                            <option>新竹區</option>
                                            <option>台中區</option>
                                            <option>嘉義區</option>
                                        </select>
                                        <select
                                            value={filterDepartment}
                                            onChange={(e) => setFilterDepartment(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>全部</option>
                                            <option>管理部</option>
                                            <option>TSE</option>
                                            <option>FAE</option>
                                            <option>新場</option>
                                            <option>倉管</option>
                                            <option>RD</option>
                                            <option>線上客服</option>
                                            </select>
                                        <select
                                            value={filterShift}
                                            onChange={(e) => setFilterShift(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>全部</option>
                                            <option>早</option>
                                            <option>晚</option>
                                        </select>
                                        <button
                                            onClick={() => exportToCSV('compensatory')}
                                            className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                        >
                                            <Download size={18} />
                                            <span>匯出Excel</span>
                                        </button>
                                    </div>
                                </div>

                              <div className="bg-white rounded-lg shadow p-4">
                                    <div className="flex items-center justify-between mb-4">
                                        <button
                                            onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1, 1))}
                                            className="px-3 py-1 border rounded hover:bg-gray-50"
                                        >
                                            上月
                                        </button>
                                        <h3 className="text-lg font-semibold">{selectedMonth.getFullYear()} 年 {selectedMonth.getMonth() + 1} 月補休安排</h3>
                                        <button
                                            onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1, 1))}
                                            className="px-3 py-1 border rounded hover:bg-gray-50"
                                        >
                                            下月
                                        </button>
                                    </div>

                                    <div className="overflow-x-auto">
                                       <table className="w-full text-sm">
                                            <thead>
                                                <tr>
                                                    <th className="sticky left-0 bg-gray-50 px-4 py-2 border">員工</th>
                                                    <th className="px-4 py-2 border">地區</th>
                                                    <th className="px-4 py-2 border">部門</th>
                                                    <th className="px-4 py-2 border">班別</th>
                                                    {getMonthDays(selectedMonth).map(day => {
                                                        const dateStr = formatLocalDate(day);
                                                        const holiday = holidays2026.find(h => h.date === dateStr);
                                                        const isWeekend = day.getDay() === 0 || day.getDay() === 6;
                                                        return (
                                                            <th
                                                                key={dateStr}
                                                                className={`min-w-[52px] px-2 py-2 border text-center ${holiday ? 'bg-red-50 text-red-600' : isWeekend ? 'bg-blue-50 text-blue-600' : 'bg-gray-50'}`}
                                                            >
                                                                {day.getDate()}
                                                            </th>
                                                        );
                                                    })}
                                                    <th className="px-4 py-2 border bg-gray-50">本月補休(時)</th>
                                                    <th className="px-4 py-2 border bg-gray-50">本月補休(天)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {data.users
                                                    .filter(u =>
                                                        (filterRegion === '全部' || u.region === filterRegion) &&
                                                        (filterDepartment === '全部' || u.department === filterDepartment) &&
                                                        (filterShift === '全部' || u.shift.includes(filterShift))
                                                    )
                                                    .map(user => {
                                                        const currentMonthStats = getCompStats(user.id, selectedMonth);
                                                        return (
                                                            <tr key={user.id} className="hover:bg-gray-50">
                                                                <td className="sticky left-0 bg-white px-4 py-2 border font-medium">{user.name}</td>
                                                                <td className="px-4 py-2 border">{user.region}</td>
                                                                <td className="px-4 py-2 border">{user.department}</td>
                                                                <td className="px-4 py-2 border">{user.shift.join('/')}</td>
                                                                {getMonthDays(selectedMonth).map(day => {
                                                                    const dateStr = formatLocalDate(day);
                                                                    const cell = getCompensatoryCellData(user.id, dateStr);
                                                                    const holiday = holidays2026.find(h => h.date === dateStr);
                                                                    const isWeekend = day.getDay() === 0 || day.getDay() === 6;
                                                                    return (
                                                                        <td
                                                                            key={`${user.id}-${dateStr}`}
                                                                            className={`px-2 py-2 border text-center font-medium ${cell ? 'text-indigo-700 bg-indigo-50' : holiday ? 'bg-red-50' : isWeekend ? 'bg-blue-50' : ''}`}
                                                                        >
                                                                            {cell || '-'}
                                                                        </td>
                                                                    );
                                                                })}
                                                                <td className="px-4 py-2 border text-center">{currentMonthStats.hours} 小時</td>
                                                                <td className="px-4 py-2 border text-center">{currentMonthStats.days} 天</td>
                                                            </tr>
                                                        );
                                                    })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 排程表 */}
                        {activeTab === 'schedule' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">排程表</h2>
                                    <button
                                        onClick={() => exportToCSV('schedule')}
                                        className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        <Download size={18} />
                                        <span>匯出Excel</span>
                                    </button>
                                </div>

                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <button
                                            onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1))}
                                            className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200"
                                        >
                                            上個月
                                        </button>
                                        <h3 className="text-xl font-bold">
                                            {selectedMonth.getFullYear()}年 {selectedMonth.getMonth() + 1}月 排程
                                        </h3>
                                        <button
                                            onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1))}
                                            className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200"
                                        >
                                            下個月
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-7 gap-2">
                                        {['日', '一', '二', '三', '四', '五', '六'].map(day => (
                                            <div key={day} className="text-center font-bold py-2 bg-gray-50 rounded">
                                                {day}
                                            </div>
                                        ))}
                                        
                                        {getMonthDays(selectedMonth).map(day => {
                                            const holiday = isHoliday(day);
                                            const weekend = isWeekend(day);
                                            const dateStr = formatLocalDate(day);
                                            const schedules = data.schedules?.filter(s => s.date === dateStr) || [];

                                            return (
                                                <div
                                                    key={day.toISOString()}
                                                    className={`min-h-24 p-2 border rounded-lg ${
                                                        holiday ? 'bg-red-50' :
                                                        weekend ? 'bg-blue-50' :
                                                        'bg-white'
                                                    } hover:shadow-md cursor-pointer transition-shadow`}
                                                   onClick={() => openScheduleModal(dateStr)}
                                                >
                                                   <div className="font-bold text-sm md:text-base mb-1">
                                                        {day.getDate()}
                                                        {holiday && <span className="ml-1 text-xs text-red-600">{holiday.name}</span>}
                                                    </div>
                                                    <div className="space-y-1">
                                                        {schedules.map(schedule => (
                                                            <div key={schedule.id} className="text-xs bg-indigo-100 text-indigo-800 p-1 rounded">
                                                                <div className="flex items-start justify-between gap-1">
                                                                    <div className="font-medium">{schedule.title}</div>
                                                                    <button
                                                                        type="button"
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            handleDeleteSchedule(schedule.id);
                                                                        }}
                                                                        className="text-red-600 hover:text-red-800"
                                                                        title="刪除行程"
                                                                    >
                                                                        <Trash2 size={14} />
                                                                    </button>
                                                                </div>
                                                                <div className="text-xs">{schedule.content}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <p className="text-sm md:text-base text-blue-800">
                                        💡 點擊日期可以新增排程。排程資料會自動儲存。
                                    </p>
                                </div>

                                {showScheduleModal && (
                                    <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50">
                                        <div className="bg-white rounded-lg shadow-lg w-full max-w-xl p-6">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-lg font-bold">新增排程（{selectedScheduleDate}）</h3>
                                                <button
                                                    type="button"
                                                    onClick={() => setShowScheduleModal(false)}
                                                    className="text-gray-500 hover:text-gray-700"
                                                >
                                                    ✕
                                                </button>
                                            </div>
                                            <form onSubmit={handleScheduleSubmit} className="space-y-3">
                                                <input
                                                    type="text"
                                                    value={scheduleForm.title}
                                                    onChange={(e) => setScheduleForm(prev => ({ ...prev, title: e.target.value }))}
                                                    placeholder="標題"
                                                    className="w-full px-3 py-2 border rounded"
                                                    required
                                                />
                                                <textarea
                                                    value={scheduleForm.content}
                                                    onChange={(e) => setScheduleForm(prev => ({ ...prev, content: e.target.value }))}
                                                    placeholder="內容"
                                                    className="w-full px-3 py-2 border rounded"
                                                    rows="4"
                                                    required
                                                />
                                                <div className="flex justify-end gap-2 pt-2">
                                                    <button
                                                        type="button"
                                                        onClick={() => setShowScheduleModal(false)}
                                                        className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
                                                    >
                                                        取消
                                                    </button>
                                                    <button
                                                        type="submit"
                                                        className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
                                                    >
                                                        儲存
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EmployeeLeaveSystem />);
    </script>
</body>
</html>
